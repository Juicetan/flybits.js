// @author Justin Lam
// @version feature/analytics:dca8caa
!function(e){var t={ready:null,store:{Property:{}},api:{},init:{},util:{},"interface":{}},r={},n={};t.cfg={HOST:"http://tenant.flybits.com/v2",CTXHOST:"https://gateway.flybits.com/ctxdata",APIKEY:"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",CTXREPORTDELAY:6e4,analytics:{REPORTDELAY:36e5,REPORTDELAYUNIT:"milliseconds",MAXSTORESIZE:100},store:{SDKPROPS:"flb.sdk.properties",RESOURCEPATH:"./res/",DEVICEID:"flb_device",USERTOKEN:"flb_usertoken",USERTOKENEXP:"flb_usertoken_expiry",ANALYTICSLASTREPORTED:"flb_analytics_lastreported",ANALYTICSLASTREPORTATTEMPTED:"flb_analytics_lastreportattempted"},res:{TAGS:"/Tags",USERS:"/Users",ZONES:"/Zones",ZONECONNECT:"/Zones/{zid}/Connect",ZONEDISCONNECT:"/Zones/{zid}/Disconnect",ZMIS:"/ZoneMomentInstances",ZMIJWT:"/ZoneMomentInstances/{zmiID}/jwt",ZMICONNECT:"/ZoneMomentInstances/{zmiID}/Connect",ZMIDISCONNECT:"/ZoneMomentInstances/{zmiID}/Disconnect",LOGIN:"/Users/Login",LOGOUT:"/Users/Logout",REGISTER:"/Users/Register",CHANGEPASS:"/Users/ChangePassword",SETREMEMBERME:"/Users/rememberMe"},coreMoments:{"com.flybits.moments.website":"native","com.flybits.moments.text":"native"}},t.VERSION="feature/analytics:dca8caa";var o=function(e){var r=new t.Deferred;return fetch(e).then(function(r){if(200!==r.status)throw(new t.Validation).addError("Configuration file not found","Reverting to default configuration. No configuration found at:"+e,{code:t.Validation.type.INVALIDARG,context:"url"});return r.json()}).then(function(e){t.util.Obj.extend(t.cfg,e),r.resolve(t.cfg)})["catch"](function(n){n instanceof t.Validation?r.reject(n):r.reject((new t.Validation).addError("Failed to read configuration file.","Reverting to default configuration. Configuration format incorrect at:"+e,{code:t.Validation.type.MALFORMED,context:"url"}))}),r.promise},i=function(e){if(!e)return console.log("> config file path not provided: using defaults"),!1;try{var r=h.readFileSync(e)}catch(n){throw new Error("Config file read failed: "+e)}try{t.util.Obj.extend(t.cfg,JSON.parse(r))}catch(n){throw new Error("Malformed Config file: "+e)}},s=function(){var e=new t.Deferred,r=t.store.Property;return r.ready.then(function(){return r.get(t.cfg.store.DEVICEID)}).then(function(e){if(e)return t.store.Session.deviceID=e,e;var n=t.util.Obj.guid();return t.store.Session.deviceID=n,r.set(t.cfg.store.DEVICEID,n)}).then(function(t){e.resolve()})["catch"](function(t){e.reject(t)}),e.promise},a=function(){t.context&&(t.context.Manager.reportDelay=t.cfg.CTXREPORTDELAY),t.analytics&&(t.analytics.Manager.reportDelay=t.cfg.analytics.REPORTDELAY,t.analytics.Manager.reportDelayUnit=t.cfg.analytics.REPORTDELAYUNIT,t.analytics.Manager.maxStoreSize=t.cfg.analytics.MAXSTORESIZE)};t.init.server=function(e){return i(e),s().then(function(){a(),m.resolve(t.cfg)})["catch"](function(e){m.reject(e)}),t.ready},t.init.browser=function(e){return o(e).then(function(){return s()}).then(function(){a(),m.resolve(t.cfg)})["catch"](function(e){m.reject(e)}),t.ready},t.initObj=function(e){return t.util.Obj.extend(t.cfg,e),s().then(function(){a(),m.resolve(t.cfg)})["catch"](function(e){m.reject(e)}),t.ready},t.Deferred=function(){Promise.settle=function(e){var t=e.map(function(e){return e.then(function(e){return{result:e,status:"resolved"}},function(e){return{result:e,status:"rejected"}})});return Promise.all(t)};var e=function(){var e=this;this.promise=new Promise(function(t,r){e.resolve=t,e.reject=r}),this.then=this.promise.then.bind(this.promise),this["catch"]=this.promise["catch"].bind(this.promise)};return e}(),t.util.Api=function(){var t={checkResult:function(e){if(e.status>=200&&e.status<300)return e;throw e},getResultStr:function(e){return e&&e.text?e.text():new Promise(function(e,t){e("")})},getResultJSON:function(e){return e.json()},toURLParams:function(e){for(var t=Object.keys(e),r=t.length,n="";r--;){var o=t[r];""!==n&&(n+="&"),n+=o+"="+encodeURIComponent(e[o])}return n},htmlEncode:function(e){return encodeURIComponent(e)},htmlDecode:function(t){return t.replace(/&#?(\w+);/g,function(t,r){return isNaN(r)&&(chars={quot:34,amp:38,lt:60,gt:62,nbsp:160,copy:169,reg:174,deg:176,frasl:47,trade:8482,euro:8364,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,permil:8240,lsaquo:8249,rsaquo:8250,spades:9824,clubs:9827,hearts:9829,diams:9830,oline:8254,larr:8592,uarr:8593,rarr:8594,darr:8595,hellip:133,ndash:150,mdash:151,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,brkbar:166,sect:167,uml:168,die:168,ordf:170,laquo:171,not:172,shy:173,macr:175,hibar:175,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Alpha:913,alpha:945,Beta:914,beta:946,Gamma:915,gamma:947,Delta:916,delta:948,Epsilon:917,epsilon:949,Zeta:918,zeta:950,Eta:919,eta:951,Theta:920,theta:952,Iota:921,iota:953,Kappa:922,kappa:954,Lambda:923,lambda:955,Mu:924,mu:956,Nu:925,nu:957,Xi:926,xi:958,Omicron:927,omicron:959,Pi:928,pi:960,Rho:929,rho:961,Sigma:931,sigma:963,Tau:932,tau:964,Upsilon:933,upsilon:965,Phi:934,phi:966,Chi:935,chi:967,Psi:936,psi:968,Omega:937,omega:969},chars[r]!==e&&(r=chars[r])),String.fromCharCode(r)})},base64Decode:function(e){return decodeURIComponent(Array.prototype.map.call(atob(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},parseResponse:function(e){return JSON.parse(e,function(e,r){return"string"==typeof r?t.htmlDecode(r):r})},parseErrorMsg:function(e){try{var t=this.parseResponse(e)}catch(r){return"Malformed server response"}var n=null;return t?t.messageJSON||t.exceptionMessage||t.message||"Unexpected error has occurred":n},parsePaging:function(e){return{offset:e.pagination.offset,limit:e.pagination.limit,total:e.pagination.totalRecords}},createNextPageCall:function(e,t,r){return r.offset+r.limit>=r.total?null:(t=t?t:{},function(){return t.paging={limit:r.limit,offset:r.offset+r.limit},e(t)})}};return t}(),t.util.Browser=function(){var e=(t.Deferred,{getCookie:function(e){var t="; "+document.cookie,r=t.split("; "+e+"=");return 2==r.length?r.pop().split(";").shift():null},setCookie:function(e,t,r){var n="";r&&(n="; expires="+r.toGMTString()),document.cookie=e+"="+t+n+"; path=/"}});return e}(),t.util.Geo=function(){var e={_toDeg:function(e){return 180*e/Math.PI},_toRad:function(e){return e*Math.PI/180},getBoundingBox:function(e){if(!e||e.length<3)throw(new t.Validation).addError("Invalid Argument","Must provide an array of lat,lng coordinates greater than 2.",{code:t.Validation.type.INVALIDARG});for(var r=e[0].lat,n=e[0].lat,o=e[0].lng,i=e[0].lng,s=1;s<e.length;s++){var a=e[s];r=a.lat<r?a.lat:r,n=a.lat>n?a.lat:n,o=a.lng<o?a.lng:o,i=a.lng>i?a.lng:i}return{min:{lat:r,lng:o},max:{lat:n,lng:i}}},getCenter:function(e){if(!e||e.length<3)throw(new t.Validation).addError("Invalid Argument","Must provide an array of lat,lng coordinates greater than 2.",{code:t.Validation.type.INVALIDARG});var r=this.getBoundingBox(e);return{lat:(r.max.lat+r.min.lat)/2,lng:(r.max.lng+r.min.lng)/2}},getBearing:function(e,t){var r=t.lng-e.lng,n=Math.sin(r)*Math.cos(t.lat),o=Math.cos(e.lat)*Math.sin(t.lat)-Math.sin(e.lat)*Math.cos(t.lat)*Math.cos(r),i=this._toDeg(Math.atan2(n,o));return 360-(i+360)%360}};return e}(),t.util.Obj=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t={extend:function(e,t){if("function"==typeof $&&"function"==typeof $.extend)return $.extend(!0,e,t);if("function"==typeof _&&"function"==typeof _.extend)return _.extend(e,t);for(var r in t)t[r]&&t[r].constructor&&t[r].constructor===Object?(e[r]=e[r]||{},arguments.callee(e[r],t[r])):e[r]=t[r];return e},guid:function(t){var r="js";if(t&&t>0){for(var n=0;n<t;n++)r+="js"!==r?"-"+e():e();return r}return"js"+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},removeObject:function(e,t,r){var n=e.indexOf(t);if(r){var o=e.filter(r);o.length>0&&(n=e.indexOf(o[0]))}return n>=0?e.splice(n,1):e}};return t}(),t["interface"].ContextPlugin={isSupported:function(){},getState:function(){},_toServerFormat:function(e){}},t["interface"].KeyDataStore={getSize:function(){},set:function(e,t){},get:function(e){},getKeys:function(){},clear:function(){}},t["interface"].Localizable={_fromLocaleJSON:function(e){},_toLocaleJSON:function(e){}},t["interface"].PropertyStore={isSupported:function(){},getItem:function(e){},setItem:function(e,t){},removeItem:function(e){}},t["interface"].Serializable={fromJSON:function(e){},toJSON:function(){}},t["interface"].Taggable={hasTag:function(e){},getTags:function(){}};var c=function(){function e(){}return e.prototype={"implements":function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),u=function(){var e=function(e){c.call(this),this.id=null,e&&(this.id=e.id)};return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype.reqKeys={id:"id"},e}();t.Moment=function(){var e=function(e){u.call(this,e),e&&this.fromJSON(e)};return e.prototype=Object.create(u.prototype),e.prototype.constructor=e,e.prototype["implements"]("Serializable"),e.prototype.MASK_ANDROID=e.MASK_ANDROID=2,e.prototype.MASK_IOS=e.MASK_IOS=1,e.prototype.RENDERTYPE_NATIVE=e.RENDERTYPE_NATIVE="native",e.prototype.RENDERTYPE_HTML=e.RENDERTYPE_HTML="html",e.prototype.RENDERTYPE_NONE=e.RENDERTYPE_NONE="none",e.prototype.fromJSON=function(e){this.name=e.name,this.icon=e.icon,this.baseNotifyURL=e.notifyUrl,this.manageURL=e.editUrl,this.clientURL=e.launchUrl,this.androidPkg=e.androidPackageName,this.iosPkg=e.iosPackageName,this.privateKey=e.sharedKey,this.ownerID=e.ownerId,this.status=e.status,this.type=e.type,this.isProduction=e.isProduction,this.renderType=e.renditionType,this.supportedDevices=e.supportedDeviceType},e.prototype.toJSON=function(){var e={name:this.name,icon:this.icon,notifyUrl:this.baseNotifyURL,editUrl:this.manageURL,launchUrl:this.clientURL,androidPackageName:this.androidPkg,iosPackageName:this.iosPkg,sharedKey:this.privateKey,ownerId:this.ownerID,status:this.status,type:this.type,isProduction:this.isProduction,renditionType:this.renderType,supportedDeviceType:this.supportedDevices};return this.id&&(e.id=this.id),e},e}(),t.MomentInstance=function(){var e=function(e){u.call(this,e),e&&this.fromJSON(e)};return e.prototype=Object.create(u.prototype),e.prototype.constructor=e,e.prototype["implements"]("Serializable"),e.prototype["implements"]("Localizable"),e.prototype._fromLocaleJSON=function(e){var t={name:e.name,desc:e.description,icon:e.icon};return t},e.prototype._toLocaleJSON=function(e){var t={name:e.name,description:e.desc,icon:e.icon};return t},e.prototype.fromJSON=function(e){var t=this;this.momentID=e.momentId,this.isConfirmed=e.isConfirmed,this.defaultLang=e.defaultLanguage,this.metadata=e.metadata,this.locales={};var r=e.localizations?Object.keys(e.localizations):[];r.forEach(function(r){t.locales[r]=t._fromLocaleJSON(e.localizations[r])}),r.length>0&&this.defaultLang&&(this.defaultLocaleObj=this.locales[this.defaultLang])},e.prototype.toJSON=function(){var e=this,t={momentId:this.momentID,isConfirmed:this.isConfirmed,defaultLanguage:this.defaultLang,metadata:this.metadata,localizations:{}};if(this.id&&(t.id=this.id),this.locales&&Object.keys(this.locales).length>0){var r=Object.keys(this.locales);r.forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])})}return t},e}(),t.Tag=function(){var e=t.util.Obj,r=function(e){u.call(this,e),e&&this.fromJSON(e)};return r.prototype=Object.create(u.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype["implements"]("Localizable"),r.prototype.reqKeys=r.reqKeys=e.extend({label:"value",icon:"icon",isVisible:"isVisible"},u.prototype.reqKeys),r.prototype._fromLocaleJSON=function(e){var t={label:e.value,icon:e.icon};return t},r.prototype._toLocaleJSON=function(e){var t={value:e.label,icon:e.icon};return t},r.prototype.fromJSON=function(e){var t=this;this.isVisible=e.isVisible,this.defaultLang=e.defaultLanguage,this.zoneIDs=e.zoneIds?e.zoneIds:[],this.zmiIDs=e.zoneMomentInstanceIds?e.zoneMomentInstanceIds:[],this.locales={};var r=e.localizations?Object.keys(e.localizations):[];r.forEach(function(r){t.locales[r]=t._fromLocaleJSON(e.localizations[r])}),r.length>0&&this.defaultLang&&(this.defaultLocaleObj=this.locales[this.defaultLang])},r.prototype.toJSON=function(){var e=this,t={isVisible:this.isVisible,defaultLanguage:this.defaultLang,zoneIds:this.zoneIDs,zoneMomentInstanceIds:this.zmiIDs,localizations:{}};if(this.id&&(t.id=this.id),Object.keys(this.locales).length>0){var r=Object.keys(this.locales);r.forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])})}return t},r}(),t.User=function(){var e=t.util.Obj,r=function(e){u.call(this,e),e&&this.fromJSON(e)};return r.prototype=Object.create(u.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype.reqKeys=r.reqKeys=e.extend({email:"email",firstName:"firstName",lastName:"lastName",profileImg:"icon"},u.prototype.reqKeys),r.prototype.fromJSON=function(e){this.email=e.email,this.firstName=e.firstName,this.lastName=e.lastName,this.profileImg=e.icon,e.credentialsJwt&&(this._authToken=e.credentialsJwt)},r.prototype.toJSON=function(){var e={email:this.email,firstName:this.firstName,lastName:this.lastName,icon:this.profileImg};return this.id&&(e.id=this.id),e},r}(),t.Validation=function(){var e=function(){this.state=!0,this.errors=[]};return e.prototype.type=e.type={},e.prototype.type.MALFORMED=e.type.MALFORMED=1e3,e.prototype.type.INVALIDARG=e.type.INVALIDARG=1001,e.prototype.type.MISSINGARG=e.type.MISSINGARG=1002,e.prototype.type.NOTFOUND=e.type.NOTFOUND=1003,e.prototype.type.CONNECTIONERROR=e.type.CONNECTIONERROR=1004,e.prototype.type.UNAUTHENTICATED=e.type.UNAUTHENTICATED=1005,e.prototype.type.RETRIEVALERROR=e.type.RETRIEVALERROR=1006,e.prototype.type.NOTSUPPORTED=e.type.NOTSUPPORTED=1007,e.prototype.type.UNEXPECTED=e.type.UNEXPECTED=1008,e.prototype={addError:function(e,t,r){this.state=!1;var n={header:e,message:t};return r&&(n.context=r.context,n.code=r.code,n.serverCode=r.serverCode),this.errors.push(n),this},firstError:function(){return this.errors.length>0?this.errors[0]:null}},e}(),t.Zone=function(){var e=t.util.Obj,r=function(e){u.call(this,e),e&&this.fromJSON(e)};return r.prototype=Object.create(u.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype["implements"]("Localizable"),r.prototype["implements"]("Taggable"),r.prototype.reqKeys=r.reqKeys=e.extend({creatorID:"creatorId",isPublished:"isPublished",name:"name",description:"description",icon:"coverImg"},u.prototype.reqKeys),r.prototype._fromLocaleJSON=function(e){var t={name:e.name,description:e.description,coverImg:e.icon};return t},r.prototype._toLocaleJSON=function(e){var t={name:e.name,description:e.description,icon:e.coverImg};return t},r.prototype.fromJSON=function(e){var t=this;this.creatorID=e.creatorId,this.geofence=e.shapes,this.isPublished=e.isPublished,this.defaultLang=e.defaultLanguage,this.timeZone=e.timeZone,this.metadata=e.metadata,e.analytics&&(this.stats={visits:e.analytics.totalUserVisits,favourited:e.analytics.favoriteCount,momentCount:e.analytics.zoneMomentCount}),e.activeUserRelationship&&(this.userContextStats={isFavourite:e.activeUserRelationship.isFavorite,zoneCenterDistance:e.activeUserRelationship.distanceToZoneCenter,zoneEdgeDistance:e.activeUserRelationship.distanceToZoneEdge,isInZone:e.activeUserRelationship.isInsideZone}),e.tagIds&&e.tagIds.items.length>0?this.tagIDs=e.tagIds.items:this.tagIDs=[],this.locales={};var r=e.localizations?Object.keys(e.localizations):[];r.forEach(function(r){t.locales[r]=t._fromLocaleJSON(e.localizations[r])}),r.length>0&&this.defaultLang&&(this.defaultLocaleObj=this.locales[this.defaultLang])},r.prototype.toJSON=function(){var e=this,t={creatorId:this.creatorID,shapes:this.geofence,isPublished:this.isPublished,defaultLanguage:this.defaultLang,metadata:this.metadata,timeZone:this.timeZone,localizations:{}};if(this.stats&&(t.analytics={totalUserVisits:this.stats.visits,favoriteCount:this.stats.favourited,zoneMomentCount:this.stats.momentCount}),this.userContextStats&&(t.activeUserRelationship={isFavorite:this.userContextStats.isFavourite,distanceToZoneCenter:this.userContextStats.zoneCenterDistance,distanceToZoneEdge:this.userContextStats.zoneEdgeDistance,isInsideZone:this.userContextStats.isInZone}),this.tagIDs&&(t.tagIds={items:this.tagIDs,numItems:this.tagIDs.length}),this.id&&(t.id=this.id),Object.keys(this.locales).length>0){var r=Object.keys(this.locales);r.forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])})}return t},r.prototype.hasTag=function(e){for(var t=this,r=this.tagIDs.length,n=!1;r--;)if(t.tagIDs[r]===e){n=!0;break}return n},r.prototype.getTags=function(){return t.api.Tag.getTags({ids:this.tagIDs})},r}(),t.ZoneMomentInstance=function(){var e=t.MomentInstance,r=t.Moment,n=t.util.Obj,o=t.Validation,i=t.Deferred,s=t.cfg,a=function(e){u.call(this,e),e&&this.fromJSON(e)};return a.prototype=Object.create(u.prototype),a.prototype.constructor=a,a.prototype["implements"]("Serializable"),a.prototype["implements"]("Taggable"),a.prototype.reqKeys=a.reqKeys=n.extend({isAutoRun:"isAutoRun",isPublished:"isPublished",name:"name",supportedDevices:"supportedDeviceType",renderType:"renditionType"},u.prototype.reqKeys),a.prototype.fromJSON=function(t){this.zoneID=t.zoneId,this.momentInstanceID=t.momentInstanceId,this.isAutoRun=t.isAutoRun,this.order=t.order,this.isPublished=t.isPublished,t.auxiliaryAncestorProperties&&(this.momentInstance=new e(t.auxiliaryAncestorProperties),this.momentInstance.id=this.momentInstanceID,this.moment=new r(t.auxiliaryAncestorProperties),this.moment.id=this.momentInstance.momentID),this.tagIDs=t.tagIds?t.tagIds:[]},a.prototype.toJSON=function(){var e={};this.momentInstance&&(e=n.extend(e,this.momentInstance.toJSON())),this.moment&&(e=n.extend(e,this.moment.toJSON()));var t={zoneId:this.zoneID,momentInstanceId:this.momentInstanceID,isAutoRun:this.isAutoRun,order:this.order,isPublished:this.isPublished,auxiliaryAncestorProperties:e,tagIds:this.tagIDs};return this.id&&(t.id=this.id),t},a.prototype.getAccessToken=function(){if(!this.id)throw(new o).addError("Malformed Model","This ZoneMomentInstance is missing an ID.",{code:o.type.MALFORMED,context:"id"});return t.api.ZoneMomentInstance.getAccessToken(this.id)},a.prototype.getRenderType=function(){if(!this.moment)throw(new o).addError("Malformed Model","This ZoneMomentInstance is missing a Moment object and its renderType.",{code:o.type.MALFORMED,context:"moment"});return this.moment.renderType},a.prototype.isCoreMoment=function(){if(this.moment){var e=this.moment.androidPkg||this.moment.iosPkg;return s.coreMoments[e]}return!1},a.prototype.getClientURL=function(){var e=this,t=new i,n=this.getRenderType();return n!==r.RENDERTYPE_HTML&&this.isCoreMoment()?this.getAccessToken().then(function(r){var n=e.moment.manageURL+"/m.html?payload="+r;t.resolve(n)})["catch"](function(e){t.reject(e)}):n!==r.RENDERTYPE_HTML?t.reject((new o).addError("Not Supported","HTML user interface does not exist.",{context:"moment.renderType",code:o.type.NOTSUPPORTED})):this.getAccessToken().then(function(r){var n=e.moment.clientURL+"?payload="+r;t.resolve(n)})["catch"](function(e){t.reject(e)}),t.promise},a.prototype.hasTag=function(e){for(var t=this,r=this.tagIDs.length,n=!1;r--;)if(t.tagIDs[r]===e){n=!0;break}return n},a.prototype.getTags=function(){return t.api.Tag.getTags({ids:this.tagIDs})},a}(),t.store.Session=function(){var e=(t.util.Browser,t.util.Api),r=t.Validation,n=t.Deferred,o=t.cfg,i={constants:{REMEMBERME:"_rememberMe"},user:null,deviceID:null,userToken:null,_userTokenRetrievedAt:null,_userTokenExpiry:null,hasRememberMe:function(){return t.store.Property.get(o.store.REMEMBERME)},resolveSession:function(e){var o=this,i=new n;return e?(this.user?i.resolve(this.user):i.reject((new r).addError("Session not found.","",{code:r.type.UNAUTHENTICATED})),i.promise):(t.api.User.getAccessToken().then(function(e){i.resolve(o.user)})["catch"](function(e){var t=e.firstError();t&&t.serverCode&&(403===t.serverCode||401===t.serverCode)?(o.clearSession(),i.reject((new r).addError("Session not found.","",{code:r.type.UNAUTHENTICATED}))):i.reject(e)}),i.promise)},setUserToken:function(r){if(this.userToken=r,r){var n=e.base64Decode(r.split(".")[1]),i=JSON.parse(n);this._userTokenExpiry=i.expiresAt?1e3*i.expiresAt:0,this._userTokenRetrievedAt=(new Date).getTime(),t.store.Property.set(o.store.USERTOKEN,r),t.store.Property.set(o.store.USERTOKENEXP,this._userTokenExpiry)}else t.store.Property.set(o.store.USERTOKEN,null),t.store.Property.set(o.store.USERTOKENEXP,null),this._userTokenExpiry=null,this._userTokenRetrievedAt=null},setSession:function(e){this.user=e,e._authToken&&this.setUserToken(e._authToken)},clearSession:function(){this.user=null,this.setUserToken(null)}};return i}();var l=function(){function e(){c.call(this)}var r=t.Deferred,n=t.Validation,o=t.util.Browser;return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype["implements"]("PropertyStore"),e.prototype.isSupported=e.isSupported=function(){var e=new r,t=new n,i="object"==typeof document&&"cookie"in document;if(i)try{o.setCookie("flbstoresupport","true"),o.setCookie("flbstoresupport","true",new Date(0)),e.resolve()}catch(s){e.reject(t.addError("Storage not supported","Access error:"+s,{context:"cookie"}))}else e.reject(t.addError("Storage not supported","Missing reference in namespace.",{context:"cookie"}));return e.promise},e.prototype.getItem=function(e){return Promise.resolve(o.getCookie(e))},e.prototype.setItem=function(e,t){return o.setCookie(e,t),Promise.resolve()},e.prototype.removeItem=function(e){return o.setCookie(e,"",new Date(0)),Promise.resolve()},e}(),d=function(){function e(e){c.call(this),this.store=localforage.createInstance({name:e})}var r=t.Deferred,n=t.Validation;return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype["implements"]("PropertyStore"),e.prototype.isSupported=e.isSupported=function(){var e=new r,t=new n,o=window&&window.localforage;return o?localforage.setItem("flbstoresupport",!0).then(function(){return localforage.removeItem("flbstoresupport")}).then(function(){e.resolve()})["catch"](function(r){e.reject(t.addError("Storage not supported","Access error:"+r,{context:"localforage"}))}):e.reject(t.addError("Storage not supported","No library detected",{context:"localforage"})),e.promise},e.prototype.getItem=function(e){return this.store.getItem(e)},e.prototype.setItem=function(e,t){return this.store.setItem(e,t)},e.prototype.removeItem=function(e){return this.store.removeItem(e)},e}(),p=function(){function e(){c.call(this),this.store=localStorage}var r=t.Deferred,n=t.Validation;return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype["implements"]("PropertyStore"),e.prototype.isSupported=e.isSupported=function(){var e=new r,t=new n,o=window&&window.localStorage;if(o)try{localStorage.setItem("flbstoresupport",!0),localStorage.removeItem("flbstoresupport"),e.resolve()}catch(i){e.reject(t.addError("Storage not supported","Access error:"+i,{context:"localStorage"}))}else e.reject(t.addError("Storage not supported","Missing reference in namespace.",{context:"localStorage"}));return e.promise},e.prototype.getItem=function(e){return Promise.resolve(this.store.getItem(e))},e.prototype.setItem=function(e,t){return this.store.setItem(e,t),Promise.resolve()},e.prototype.removeItem=function(e){return this.store.removeItem(e),Promise.resolve()},e}(),f=function(){function e(){c.call(this),this.store={}}t.Deferred,t.Validation;return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype["implements"]("PropertyStore"),e.prototype.isSupported=e.isSupported=function(){return Promise.resolve()},e.prototype.getItem=function(e){return Promise.resolve(this.store[e])},e.prototype.setItem=function(e,t){return this.store[e]=t,Promise.resolve()},e.prototype.removeItem=function(e){return delete this.store[e],Promise.resolve()},e}();if(t.store.Property.browser=function(){var e=t.Deferred,r=t.Validation,n=new e,o=function(){var n=new e,o=[d,p,l,f],i=function(){o.length<1&&n.reject((new r).addError("No supported property storage engines"));var e=o.shift();e.isSupported().then(function(){n.resolve(new e(t.cfg.store.SDKPROPS))})["catch"](function(){i()})};return i(),n.promise},i={ready:n.promise,init:function(){var e=this,t=o();return t.then(function(t){e.storageEngine=t,n.resolve()}),t},remove:function(e){return this.storageEngine.removeItem(e)},set:function(e,t){return t?this.storageEngine.setItem(e,t):this.remove(e)},get:function(e){return this.storageEngine.getItem(e)}};return i}(),t.store.Property.server=function(){var e,r=t.Deferred,n=new r,o={ready:n.promise,init:function(){e=g.create({dir:t.cfg.store.RESOURCEPATH}),e.initSync(),n.resolve()},remove:function(t){var n=new r,o=this;return e.removeItem(t).then(function(){n.resolve(o)})["catch"](function(e){n.reject(e)}),n.promise},set:function(t,n){var o=new r,i=this;return n?(e.setItem(t,n).then(function(){o.resolve(i)})["catch"](function(e){o.reject(e)}),o.promise):this.remove(t)},get:function(t){var n=new r;return e.getItem(t).then(function(e){n.resolve(e)})["catch"](function(e){n.reject(e)}),n.promise}};return o}(),r.Manager=function(){var e=t.Deferred,n=t.Validation,o=t.util.Obj,i=t.util.Api,s=t.store.Session,a={services:[],reportDelay:6e4,_reportTimeout:null,isReporting:!1,register:function(t){var o=this,i=new e;return t instanceof r.ContextPlugin?(t.isSupported().then(function(){t.refreshDelay===t.refreshInterval.ONETIME?t.collectState().then(function(){o.services.push(t),i.resolve(t)})["catch"](function(e){i.reject(e)}):(t.startService(),o.services.push(t),i.resolve(t))})["catch"](function(e){i.reject(e)}),i.promise):(i.reject((new n).addError("Invalid Context Plugin","Provided parameter was not a valid Flybits.context.ContextPlugin instance.",{code:n.type.NOTSUPPORTED,context:"contextPlugin"})),i.promise)},unregister:function(e){return e instanceof r.ContextPlugin&&(o.removeObject(this.services,e),e.stopService()),e},unregisterAll:function(){return this.stopAllServices(),this.services=[],this},stopAllServices:function(){for(var e=this.services,t=0;t<e.length;t++)e[t].stopService();return this},startAllServices:function(){for(var e=this.services,t=0;t<e.length;t++)e[t].startService();return this},startReporting:function(){var t=new e,r=this;return r.stopReporting(),s.resolveSession().then(function(e){var n;n=function(){r.report()["catch"](function(e){}).then(function(){r.isReporting&&(r._reportTimeout=setTimeout(function(){n()},r.reportDelay))}),r.isReporting=!0},n(),t.resolve()})["catch"](function(e){t.reject(e)}),t.promise},stopReporting:function(){return this.isReporting=!1,window.clearTimeout(this._reportTimeout),this},_gatherAllData:function(){for(var t=new e,r=this.services,n=[],o=[],i=[],s=0;s<r.length;s++)!function(e){var t=e._fetchCollected();i.push(t),t.then(function(t){Array.prototype.push.apply(n,t.data),o.push({serviceRef:e,keys:t.keys})})}(r[s]);return Promise.settle(i).then(function(){t.resolve({data:n,keys:o})}),t.promise},_sendReport:function(r,o){var s=new e,a=t.cfg.CTXHOST;return fetch(a,{method:"POST",credentials:"include",headers:{"X-Authorization":r},body:JSON.stringify(o)}).then(i.checkResult).then(i.getResultStr).then(function(e){s.resolve()})["catch"](function(e){i.getResultStr(e).then(function(t){var r=i.parseErrorMsg(t);s.reject((new n).addError("Context report failed.",r,{serverCode:e.status}))})}),s.promise},_cleanupServices:function(t){for(var r=new e,n=[],o=0;o<t.length;o++)!function(e){n.push(e.serviceRef._deleteCollected(e.keys))}(t[o]);return Promise.settle(n).then(function(){r.resolve()}),r.promise},report:function(){var t=this,r=new e,o=s.userToken,i=[];return o?(this._gatherAllData().then(function(e){return i=e.keys,t._sendReport(o,e.data)}).then(function(){return t._cleanupServices(i)}).then(function(){r.resolve()})["catch"](function(e){e instanceof n?r.reject(e):r.reject((new n).addError("Context report failed.",e,{code:n.UNEXPECTED}))}),r.promise):(r.reject(),r.promise)}};return a.reportDelay=t.cfg.CTXREPORTDELAY,a}(),r.ContextPlugin=function(){var e=t.Deferred,r=(t.Validation,function(e){if("Object"===this.constructor.name)throw new Error("Abstract classes cannot be instantiated");c.call(this),this._refreshTimeout=null,this.refreshDelay=e&&e.refreshDelay?e.refreshDelay:this.refreshInterval.ONEMINUTE,this.maxStoreSize=e&&e.maxStoreSize?e.maxStoreSize:80,this.maxStoreAge=e&&e.maxStoreAge?e.maxStoreAge:864e5,this.isServiceRunning=!1,this.lastCollected=-1,window.localforage?this._store=localforage.createInstance({name:this.TYPEID}):(console.error("> WARNING ("+this.TYPEID+"): `localforage` dependency not found. Reverting to temporary in memory storage."),this._store={contents:{},keys:function(){return Promise.resolve(Object.keys(this.contents))},removeItem:function(e){return delete this.contents[e],Promise.resolve()},setItem:function(e,t){return this.contents[e]=t,Promise.resolve(t)},getItem:function(e){var t=this.contents[e]?this.contents[e]:null;return Promise.resolve(t)},length:function(){return Promise.resolve(Object.keys(this.contents).length)}})});return r.prototype=Object.create(c.prototype),r.prototype.constructor=r,r.prototype["implements"]("ContextPlugin"),r.prototype.refreshInterval=r.refreshInterval={},r.prototype.refreshInterval.ONETIME=r.refreshInterval.ONETIME=-42,r.prototype.refreshInterval.THIRTYSECONDS=r.refreshInterval.THIRTYSECONDS=3e4,r.prototype.refreshInterval.ONEMINUTE=r.refreshInterval.ONEMINUTE=6e4,r.prototype.refreshInterval.ONEHOUR=r.refreshInterval.ONEHOUR=36e5,r.prototype.refreshInterval.ONEDAY=r.refreshInterval.ONEDAY=864e5,r.prototype.TYPEID=r.TYPEID="ctx.sdk.generic",r.prototype.startService=function(){this.stopService();var e;return e=function(t){t.collectState()["catch"](function(e){}).then(function(){t.isServiceRunning&&(t._refreshTimeout=setTimeout(function(){e(t)},t.refreshDelay))}),t.isServiceRunning=!0},e(this),this},r.prototype.stopService=function(){return this.isServiceRunning=!1,window.clearTimeout(this._refreshTimeout),this},r.prototype.collectState=function(){var t=new e,r=this,n=this._store,o=0;return n.length().then(function(e){return o=e,r.getState()}).then(function(e){return r._saveState(e)}).then(function(){r.lastCollected=(new Date).getTime(),o>=r.maxStoreSize&&r._validateStoreState(),t.resolve()})["catch"](function(e){console.error(">",r,e),t.reject()}),t.promise},r.prototype._validateStoreState=function(){var t=this,r=new e,n=[],o=this._store;return o.keys().then(function(e){var i=e,s=(new Date).getTime(),a=i.length-t.maxStoreSize;if(i.sort(function(e,t){return+e-+t}),a>0)for(var c=0;c<a;c++)n.push(o.removeItem(i.shift()));for(;i.length>0&&s-i[0]>=t.refreshInterval.ONEDAY;)n.push(o.removeItem(i.shift()));Promise.settle(n).then(function(){r.resolve()})})["catch"](function(){r.reject()}),r.promise},r.prototype._fetchCollected=function(){var t=this,r=new e,n=[],o=[],i=this._store;return i.keys().then(function(e){var s;(s=function(){if(e.length<=0)return void r.resolve({data:n,keys:o});var a=e.pop();o.push(a),i.getItem(a).then(function(e){n.push({timestamp:Math.round(+a/1e3),dataTypeID:t.TYPEID,value:t._toServerFormat(e)
})})["catch"](function(){}).then(function(){s()})})()})["catch"](function(e){r.reject(e)}),r.promise},r.prototype._deleteCollected=function(t){var r,n=this._store,o=new e;return r=function(){if(t.length<=0)return void o.resolve();var e=t.pop();n.removeItem(e)["catch"](function(){}).then(function(){r()})},r(),o.promise},r.prototype._saveState=function(e){var t=(new Date).getTime();return this._store.setItem(t,e)},r}(),r.Connectivity=function(){var e=t.Deferred,n=t.util.Obj,o=function(e){r.ContextPlugin.call(this,e),e&&(this.opts=n.extend({},this.opts),n.extend(this.opts,e))};return o.prototype=Object.create(r.ContextPlugin.prototype),o.prototype.constructor=o,o.prototype.TYPEID=o.TYPEID="ctx.sdk.network",o.isSupported=o.prototype.isSupported=function(){var t=new e;return t.resolve(),t.promise},o.getState=o.prototype.getState=function(){var r=new e,n=this;return"onLine"in navigator&&!this.opts.hardCheck?r.resolve({state:navigator.onLine?n.state.CONNECTED:n.state.DISCONNECTED}):fetch(t.cfg.HOST+"/ping").then(function(e){r.resolve({state:n.state.CONNECTED})})["catch"](function(e){r.resolve({state:n.state.DISCONNECTED})}),r.promise},o._toServerFormat=o.prototype._toServerFormat=function(e){return{connectionType:e.state}},o.state=o.prototype.state={},o.state.DISCONNECTED=o.prototype.state.DISCONNECTED=-1,o.state.CONNECTED=o.prototype.state.CONNECTED=-99,o.opts=o.prototype.opts={hardCheck:!1},o}(),r.Location=function(){var e=t.Deferred,n=t.util.Obj,o=function(e){r.ContextPlugin.call(this,e),e&&(this.opts=n.extend({},this.opts),n.extend(this.opts,e))};return o.prototype=Object.create(r.ContextPlugin.prototype),o.prototype.constructor=o,o.prototype.TYPEID=o.TYPEID="ctx.sdk.location",o.isSupported=o.prototype.isSupported=function(){var r=new e;return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){r.resolve()},function(e){console.error(">",e),r.reject((new t.Validation).addError("Location Sensing Not Supported",e.message?e.message:"User denied"))}):r.reject((new t.Validation).addError("Location Sensing Not Supported","Device GeoLocation API not found.")),r.promise},o.getState=o.prototype.getState=function(){var r=new e;return navigator.geolocation.getCurrentPosition(function(e){r.resolve({coords:{latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy},timestamp:e.timestamp})},function(e){console.error(">",e),r.reject((new t.Validation).addError("Location could not be resolved"))},this.opts),r.promise},o._toServerFormat=o.prototype._toServerFormat=function(e){return{lat:e.coords.latitude,lng:e.coords.longitude}},o.opts=o.prototype.opts={maximumAge:12e5},o}(),n.Event=function(){var e=t.util.Obj,r=function(t){u.call(this,t),this._tmpID=e.guid(1)+"-"+Date.now(),this.type=this.types.DISCRETE,this.name="",this.loggedAt=new Date,this.properties={},this._internal={},this._isInternal=!1,t&&this.fromJSON(t)};return r.prototype=Object.create(u.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype.types=r.types={},r.prototype.types.DISCRETE=r.types.DISCRETE="event_discrete",r.prototype.types.TIMEDSTART=r.types.TIMEDSTART="event_timestart",r.prototype.types.TIMEDEND=r.types.TIMEDEND="event_timeend",r.prototype.TIMEDREFID=r.TIMEDREFID="timedRef",r.prototype.OSTYPE=r.OSTYPE="osType",r.prototype.OSVERSION=r.OSVERSION="osVersion",r.prototype._setProp=function(e,t,r){return"undefined"==typeof r||null===r?(delete e[t],this):(e[t]=r,this)},r.prototype.setProperty=function(e,t){return this._setProp(this.properties,e,t)},r.prototype._setInternalProperty=function(e,t){return this._setProp(this._internal,e,t)},r.prototype.fromJSON=function(e){this.type=e.type||this.types.DISCRETE,this.name=e.name,this.loggedAt=e.loggedAt?new Date(e.loggedAt):new Date,this.properties=e.properties||{},this._internal=e.flbProperties||{},this._isInternal=e.isFlybits||!1},r.prototype.toJSON=function(){var e={type:this.type,name:this.name,loggedAt:this.loggedAt.getTime(),properties:this.properties,flbProperties:this._internal,isFlybits:this._isInternal};return e},r}(),n.Manager=function(){var e=t.Deferred,r=t.Validation,o=t.store.Session,i=n.Event,s=function(){var e=t.store.Property.get(t.cfg.store.ANALYTICSLASTREPORTED).then(function(e){e&&(l.lastReported=+e)}),r=t.store.Property.get(t.cfg.store.ANALYTICSLASTREPORTATTEMPTED).then(function(e){e&&(l.lastReportAttempted=+e)});return Promise.settle([e,r])},a=function(e){return"object"==typeof window?(e._setInternalProperty(i.OSTYPE,"browser"),window.hasOwnProperty("navigator")&&e._setInternalProperty(i.OSVERSION,navigator.userAgent)):(e._setInternalProperty(i.OSTYPE,"node"),"undefined"!=typeof process&&e._setInternalProperty(i.OSVERSION,process.version)),e},c={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5},u=function(e,t){var r=c[t]||1;return e*r},l={maxStoreSize:100,reportDelay:36e5,reportDelayUnit:"milliseconds",lastReported:null,lastReportAttempted:null,_reportTimeout:null,_analyticsStore:null,_uploadChannel:null,_timedEventCache:{},isReporting:!1,initialize:function(){var r=new e,o=this;return this._analyticsStore=new n.BrowserStore({maxStoreSize:t.cfg.analytics.MAXSTORESIZE}),this._uploadChannel=new n.DefaultChannel,s().then(function(){return o.startReporting()}).then(function(){r.resolve()})["catch"](function(e){r.reject(e)}),r.promise},stopReporting:function(){return this.isReporting=!1,clearTimeout(this._reportTimeout),this},startReporting:function(){var r=new e,n=this;n.stopReporting();var i=o.user?Promise.resolve(o.user):t.api.User.getSignedInUser();return i.then(function(e){var t;t=function(){n.report()["catch"](function(e){}).then(function(){n.isReporting&&(n._reportTimeout=setTimeout(function(){t()},u(n.reportDelay,n.reportDelayUnit)))}),n.isReporting=!0},t(),r.resolve()})["catch"](function(e){r.reject(e)}),r.promise},report:function(){var n,o=new e,i=this;return this._analyticsStore.getAllEvents().then(function(e){if(n=e.map(function(e){return e._tmpID}),n.length<1)throw(new r).addError("No analytics to upload.","",{code:r.type.NOTFOUND});return i._uploadChannel.uploadEvents(e)}).then(function(){return i.lastReported=Date.now(),t.store.Property.set(t.cfg.store.ANALYTICSLASTREPORTED,i.lastReported),i._analyticsStore.clearEvents(n)}).then(function(){o.resolve()})["catch"](function(e){e instanceof r&&e.firstError().code!==r.type.NOTFOUND&&console.error("> analytics report error",e),o.reject(e)}).then(function(){i.lastReportAttempted=Date.now(),t.store.Property.set(t.cfg.store.ANALYTICSLASTREPORTATTEMPTED,i.lastReportAttempted)}),o.promise},logEvent:function(e,t){var r=new i({name:e,type:i.types.DISCRETE,properties:t});return a(r),this._analyticsStore.addEvent(r)},startTimedEvent:function(t,r){var n=this,o=new e,s=new i({name:t,type:i.types.TIMEDSTART,properties:r});return a(s),s._setInternalProperty(i.TIMEDREFID,s._tmpID),this._analyticsStore.addEvent(s).then(function(){n._timedEventCache[s._tmpID]=s,o.resolve(s._tmpID)})["catch"](function(e){o.reject(e)}),o.promise},endTimedEvent:function(t){var n=this,o=new e,s=n._timedEventCache[t];if(!t||!s)return o.reject((new r).addError("No Timed Event Found","No corresponding start event was found for provided reference.",{code:r.type.NOTFOUND,context:t})),o.promise;var a=new i({name:s.name,type:i.types.TIMEDEND,properties:s.properties});return a._internal=s._internal,a._isInternal=s._isInternal,this._analyticsStore.addEvent(a).then(function(){delete n._timedEventCache[t],o.resolve()})["catch"](function(e){o.reject(e)}),o.promise}};return l}(),n.AnalyticsStore=function(){var e=(t.Deferred,t.Validation,function(e){if("Object"===this.constructor.name)throw new Error("Abstract classes cannot be instantiated");this.maxStoreSize=e&&e.maxStoreSize?e.maxStoreSize:100});return e.prototype={"implements":function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),n.BrowserStore=function(){var e=t.Deferred,r=t.Validation,o=t.util.Obj,i=n.Event,s=function(e){n.AnalyticsStore.call(this,e),e&&(this.opts=o.extend({},this.opts),o.extend(this.opts,e)),window.localforage?this._store=localforage.createInstance({name:this.STOREID}):(console.error("> WARNING ("+this.STOREID+"): `localforage` dependency not found. Reverting to temporary in memory storage."),this._store={contents:{},keys:function(){return Promise.resolve(Object.keys(this.contents))},removeItem:function(e){return delete this.contents[e],Promise.resolve()},setItem:function(e,t){return this.contents[e]=t,Promise.resolve(t)},getItem:function(e){var t=this.contents[e]?this.contents[e]:null;return Promise.resolve(t)},length:function(){return Promise.resolve(Object.keys(this.contents).length)}})};return s.prototype=Object.create(n.AnalyticsStore.prototype),s.prototype.constructor=s,s.prototype.STOREID=s.STOREID="flb.analytics",s.prototype.addEvent=function(t){var n=new e,o=this,s=this._store,a=0;return t instanceof i?(s.length().then(function(e){return a=e,o._saveState(t)}).then(function(){a>=o.maxStoreSize?plugin._validateStoreState().then(function(){n.resolve()}):n.resolve()})["catch"](function(e){n.reject(e)}),n.promise):(n.reject((new r).addError("Invalid Argument","Must be an instance of an analytics Event",{code:r.type.INVALIDARG})),n.promise)},s.prototype.getEvent=function(t){var r=new e;return this._store.getItem(t).then(function(e){if(e){var n=new i(e);n.tmpID=t,r.resolve(n)}else r.resolve()})["catch"](function(e){r.reject(e)}),r.promise},s.prototype.clearEvents=function(t){var r,n=this._store,o=new e;return r=function(){if(t.length<=0)return void o.resolve();var e=t.pop();n.removeItem(e)["catch"](function(){}).then(function(){r()})},r(),o.promise},s.prototype.clearAllEvents=function(){return this._store.clear()},s.prototype.getAllEvents=function(){var t=new e,r=[],n=this._store;return n.iterate(function(e,t,n){var o=new i(e);o.tmpID=t,r.push(o)}).then(function(){t.resolve(r)})["catch"](function(e){t.reject(e)}),t.promise},s.prototype._saveState=function(e){return this._store.setItem(e.tmpID,e.toJSON())},s.prototype._validateStoreState=function(){var t=this,r=new e,n=[],o=this._store;return o.keys().then(function(e){var i=e,s=((new Date).getTime(),i.length-t.maxStoreSize);if(i.sort(function(e,t){return+e.split("-")[1]-+t.split("-")[1]}),s>0)for(var a=0;a<s;a++)n.push(o.removeItem(i.shift()));Promise.settle(n).then(function(){r.resolve()})})["catch"](function(){r.reject()}),r.promise},s}(),n.UploadChannel=function(){var e=(t.store.Session,function(e){if("Object"===this.constructor.name)throw new Error("Abstract classes cannot be instantiated")});return e.prototype={"implements":function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),n.DefaultChannel=function(){var e=t.Deferred,r=t.Validation,o=t.util.Api,i=t.store.Session,s=(n.Event,function(e){n.UploadChannel.call(this,e),this.sessionKey=null,this.HOST=t.cfg.analytics.CHANNELHOST,this.channelKey=t.cfg.analytics.CHANNELKEY,this.appID=t.cfg.analytics.APPID});return s.prototype=Object.create(n.UploadChannel.prototype),s.prototype.constructor=s,s.prototype.initSession=function(){var t=new e,n=this,i=this.HOST+"/session?key="+this.channelKey;return fetch(i,{method:"GET"}).then(o.checkResult).then(o.getResultStr).then(function(e){try{var i=o.parseResponse(e);n.sessionKey=i.key,t.resolve()}catch(s){t.reject((new r).addError("Registration Failed","Unexpected server response.",{code:r.type.MALFORMED}))}})["catch"](function(e){o.getResultStr(e).then(function(n){var i=o.parseErrorMsg(n);t.reject((new r).addError("Context report failed.",i,{serverCode:e.status}))})}),t.promise},s.prototype._preparePayload=function(e){return{deviceID:i.deviceID,data:e.map(function(e){var t=e.toJSON();return t.properties._uid=i.user.id,t})}},s.prototype._upload=function(t){var n=new e,i=this.HOST+"/events";return fetch(i,{method:"POST",headers:{key:this.sessionKey,appid:this.appID,"Content-Type":"application/json"},body:JSON.stringify(t)}).then(o.checkResult).then(o.getResultStr).then(function(e){n.resolve()})["catch"](function(e){o.getResultStr(e).then(function(t){var i=o.parseErrorMsg(t);n.reject((new r).addError("Analytics report failed.",i,{serverCode:e.status}))})}),n.promise},s.prototype.uploadEvents=function(e){var t=this,r=this._preparePayload(e),n=Promise.resolve();return this.sessionKey||(n=this.initSession()),n.then(function(){return t._upload(r)})},s}(),t.api.Tag=function(){var e=t.util.Api,r=t.Validation,n=t.Deferred,o=t.Tag,i=t.store.Session,s=null,a=function(e){var t={};if(!e)return t;if(e.id||e.ids){var n=e.ids?e.ids:[];e.id&&n.push(e.id),t.ids=n.join(";")}if(e.zid||e.zids){var i=e.zids?e.zids:[];e.zid&&i.push(e.zid),t.zoneids=i.join(";")}if(e.zmiID||e.zmiIDs){var s=e.zmiIDs?e.zmiIDs:[];e.zmiID&&s.push(e.zmiID),t.zonemomentinstanceids=s.join(";")}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new r).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:r.type.MISSINGARG});e.paging.limit&&(t.limit=e.paging.limit),e.paging.offset&&(t.offset=e.paging.offset)}if(e.orderBy){var a=e.orderBy.key;if(!a)throw(new r).addError("Missing Argument","orderBy requires a Tag model property key to order by.",{code:r.type.MISSINGARG,context:"orderBy.key"});if(!o.reqKeys[a])throw(new r).addError("Invalid Argument","Tag does not contain or cannot be ordered by this property:"+a,{code:r.type.INVALIDARG,context:"orderBy.key"});a=o.reqKeys[a];var c=e.orderBy.direction?e.orderBy.direction:"ascending";t.orderby=a+":"+c}if(e.search){for(var u=Object.keys(e.search),l=u.length,d={},p=[],f=new r;l--;){var h=u[l],g=e.search[h];o.reqKeys[h]||f.addError("Invalid Argument","Tag does not contain or cannot be searched by this property:"+h,{code:r.type.INVALIDARG,context:"search"}),h=o.reqKeys[h],d[g]?d[g]+=";"+h:d[g]=h}if(!f.state)throw f;for(var m=Object.keys(d),y=m.length;y--;){var v=m[y],I=d[v];p.push(v+":"+I)}t.search="search="+p.join("&search=")}return t},c={getPaging:function(){return s},findTags:function(e){return this.getTags({search:{label:e}})},getTag:function(e){var t=this,o=new n;if(!e||""===e)throw(new r).addError("Missing Argument","No Tag ID was provided.",{code:r.type.MISSINGARG,context:"id"});return this.getTags({id:e}).then(function(e){var n=e.result;n.length<=0&&0===t.getPaging().total?o.reject((new r).addError("Model Not Found","A Tag was not found with the supplied ID",{code:r.type.NOTFOUND,context:"id"})):n.length>0&&o.resolve(n[0])})["catch"](function(e){o.reject(e)}),o.promise},getTags:function(c){var u=new n,l=t.cfg.HOST+t.cfg.res.TAGS,d=a(c),p=i.deviceID;return d.search&&(l+="?"+d.search,delete d.search),d=e.toURLParams(d),""!==d&&(l+=l.indexOf("?")<0?"?":"&",l+=d.toString()),fetch(l,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(n){try{var i=e.parseResponse(n),a=e.parsePaging(i);s=a}catch(l){u.reject((new r).addError("Request Failed","Unexpected server response.",{code:r.type.MALFORMED}))}if(i&&i.data&&i.data.length>=0){var d=i.data.map(function(e){try{return new o(e)}catch(t){u.reject((new r).addError("Request Failed","Failed to parse server model.",{code:r.type.MALFORMED,context:i.data[0]}))}});u.resolve({result:d,nextPageFn:e.createNextPageCall(t.api.Tag.getTags,c,a)})}else u.reject((new r).addError("Tags retrieval failed","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);u.reject((new r).addError("Tags retrieval failed",o,{serverCode:t.status}))})}),u.promise}};return c}(),t.api.User=function(){var e=t.util.Api,r=t.util.Obj,n=t.Validation,o=t.Deferred,i=t.User,s=t.store.Session,a=null,c=function(e){var t={includeAllUsers:!0};if(!e)return t;if(e.id||e.ids){var r=e.ids?e.ids:[];e.id&&r.push(e.id),t.ids=r.join(";")}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new n).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:n.type.MISSINGARG});e.paging.limit&&(t.limit=e.paging.limit),e.paging.offset&&(t.offset=e.paging.offset)}if(e.orderBy){var o=e.orderBy.key;if(!o)throw(new n).addError("Missing Argument","orderBy requires a User model property key to order by.",{code:n.type.MISSINGARG,context:"orderBy.key"});if(!i.reqKeys[o])throw(new n).addError("Invalid Argument","User does not contain or cannot be ordered by this property:"+o,{code:n.type.INVALIDARG,context:"orderBy.key"});o=i.reqKeys[o];var s=e.orderBy.direction?e.orderBy.direction:"ascending";t.orderby=o+":"+s}if(e.search){for(var a=Object.keys(e.search),c=a.length,u={},l=[],d=new n;c--;){var p=a[c],f=e.search[p];i.reqKeys[p]||d.addError("Invalid Argument","User does not contain or cannot be searched by this property:"+p,{code:n.type.INVALIDARG,context:"search"}),p=i.reqKeys[p],u[f]?u[f]+=";"+p:u[f]=p}if(!d.state)throw d;for(var h=Object.keys(u),g=h.length;g--;){var m=h[g],y=u[m];l.push(m+":"+y)}t.search="search="+l.join("&search=")}return t},u=function(){var r=new o,n=t.cfg.HOST+t.cfg.res.SETREMEMBERME,i=s.deviceID;return fetch(n,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:i,"Content-Type":"application/json"}}).then(e.checkResult).then(e.getResultStr).then(function(e){r.resolve()})["catch"](function(e){r.reject()}),r.promise},l={register:function(r,a,c){var u=new o,l=t.cfg.HOST+t.cfg.res.REGISTER,d=s.deviceID,p={email:r,password:a,includeCredentialsJwt:!0};c&&(c.firstName&&(p.firstName=c.firstName),c.lastName&&(p.lastName=c.lastName),c.hasOwnProperty("includeAccessToken")&&(p.includeCredentialsJwt=c.includeAccessToken));var f=new n;if(r||f.addError("Missing Argument","Email is a required field for registration",{context:"email",code:n.type.MISSINGARG}),a||f.addError("Missing Argument","Password is a required field for registration",{context:"password",code:n.type.MISSINGARG}),!f.state)throw f;return fetch(l,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:d,"Content-Type":"application/json"},body:JSON.stringify(p)}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var r=e.parseResponse(t)}catch(o){u.reject((new n).addError("Registration Failed","Unexpected server response.",{code:n.type.MALFORMED}))}try{var a=new i(r);s.setSession(a),u.resolve(a)}catch(o){u.reject((new n).addError("User resolution failed.","Failed to parse server model.",{code:n.type.MALFORMED,context:r}))}})["catch"](function(t){e.getResultStr(t).then(function(r){var o=e.parseErrorMsg(r);u.reject((new n).addError("Registration Failed",o,{serverCode:t.status}))})}),u.promise},anonymousLogin:function(){var e=new o,n=r.guid()+"@flybits.eu",i=r.guid(2),a=null;return t.api.User.register(n,i,{firstName:"anonymous",lastName:r.guid(1)}).then(function(e){return a=e,u()}).then(function(){s.setSession(a),e.resolve(a)})["catch"](function(t){e.reject(t)}),e.promise},getPaging:function(){return a},login:function(r,a,c){var u=new o,l=t.cfg.HOST+t.cfg.res.LOGIN,d=s.deviceID,p={email:r,password:a,includeCredentialsJwt:!0};c&&(c.hasOwnProperty("rememberMe")&&(p.rememberMe=c.rememberMe),c.hasOwnProperty("includeAccessToken")&&(p.includeCredentialsJwt=c.includeAccessToken));var f=new n;if(r||f.addError("Missing Argument","Email is required to login",{context:"email",code:n.type.MISSINGARG}),a||f.addError("Missing Argument","Password is required to login",{context:"password",code:n.type.MISSINGARG}),d||f.addError("Missing Argument","A unique device ID is required to login",{context:"deviceID",code:n.type.MISSINGARG}),!f.state)throw f;return fetch(l,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:d,"Content-Type":"application/json","flybits-sdk-version":t.VERSION},body:JSON.stringify(p)}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var r=e.parseResponse(t)}catch(o){u.reject((new n).addError("Login Failed","Unexpected server response.",{code:n.type.MALFORMED}))}try{var a=new i(r);s.setSession(a),u.resolve(a)}catch(o){u.reject((new n).addError("User resolution failed.","Failed to parse server model.",{code:n.type.MALFORMED,context:r}))}})["catch"](function(t){e.getResultStr(t).then(function(r){var o=e.parseErrorMsg(r);u.reject((new n).addError("Login Failed",o,{serverCode:t.status}))})}),u.promise},logout:function(){var r=new o,i=t.cfg.HOST+t.cfg.res.LOGOUT,a=s.deviceID;return fetch(i,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:a,"flybits-sdk-version":t.VERSION}}).then(function(){r.resolve()})["catch"](function(t){e.getResultStr(t).then(function(o){var i=e.parseErrorMsg(o);r.reject((new n).addError("Logout Failed",i,{serverCode:t.status}))})}).then(function(){s.clearSession()}),r.promise},getAccessToken:function(){var r=new o,i=t.cfg.HOST+t.cfg.res.USERS+"/jwt",a=s.deviceID;return fetch(i,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:a,"Content-Type":"application/json","flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var o=e.parseResponse(t)}catch(i){r.reject((new n).addError("Request Failed","Unexpected server response.",{code:n.type.MALFORMED}))}o&&o.jwt?(s.setUserToken(o.jwt),r.resolve(o.jwt)):r.reject((new n).addError("User access token retrieval failed","Unexpected server response",{code:n.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(o){var i=e.parseErrorMsg(o);r.reject((new n).addError("User access token retrieval failed",i,{serverCode:t.status}))})}),r.promise},changePassword:function(r,i){var a=new o,c=t.cfg.HOST+t.cfg.res.CHANGEPASS,u=s.deviceID;return fetch(c,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:u,"Content-Type":"application/json","flybits-sdk-version":t.VERSION},body:JSON.stringify({currentPassword:r,newPassword:i})}).then(e.checkResult).then(e.getResultStr).then(function(e){a.resolve()})["catch"](function(t){e.getResultStr(t).then(function(r){var o=e.parseErrorMsg(r);a.reject((new n).addError("Password change failed",o,{serverCode:t.status}))})}),a.promise},getSignedInUser:function(){var r=new o,a=t.cfg.HOST+t.cfg.res.USERS,c=s.deviceID;return fetch(a,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"Content-Type":"application/json","flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var o=e.parseResponse(t)}catch(a){r.reject((new n).addError("Request Failed","Unexpected server response.",{code:n.type.MALFORMED}))}if(o&&o.data&&o.data.length>0)try{var c=new i(o.data[0]);s.setSession(c),r.resolve(c)}catch(a){r.reject((new n).addError("Request Failed","Failed to parse server model.",{code:n.type.MALFORMED,context:o.data[0]}))}else r.reject((new n).addError("User retrieval failed","Unexpected server response",{code:n.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(o){var i=e.parseErrorMsg(o);r.reject((new n).addError("User retrieval failed",i,{serverCode:t.status}))})}),r.promise},getUser:function(e){var t=this,r=new o;if(!e||""===e)throw(new n).addError("Missing Argument","No User ID specified",{code:n.type.MISSINGARG,context:"id"});return this.getUsers({id:e}).then(function(e){var o=e.result;o.length<=0&&0===t.getPaging().total?r.reject((new n).addError("Model Not Found","A User was not found with the supplied ID",{code:n.type.NOTFOUND,context:"id"})):o.length>0&&r.resolve(o[0])})["catch"](function(e){r.reject(e)}),r.promise},getUsers:function(r){var u=new o,l=t.cfg.HOST+t.cfg.res.USERS,d=c(r),p=s.deviceID;return d.search&&(l+="?"+d.search,delete d.search),d=e.toURLParams(d),""!==d&&(l+=l.indexOf("?")<0?"?":"&",l+=d.toString()),fetch(l,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(o){try{var s=e.parseResponse(o),c=e.parsePaging(s);a=c}catch(l){u.reject((new n).addError("Request Failed","Unexpected server response.",{code:n.type.MALFORMED}))}if(s&&s.data&&s.data.length>=0){var d=s.data.map(function(e){try{return new i(e)}catch(t){u.reject((new n).addError("Request Failed","Failed to parse server model.",{code:n.type.MALFORMED,context:e}))}});u.resolve({result:d,nextPageFn:e.createNextPageCall(t.api.User.getUsers,r,c)})}else u.reject((new n).addError("Users retrieval failed","Unexpected server response",{code:n.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(r){var o=e.parseErrorMsg(r);u.reject((new n).addError("Users retrieval failed",o,{serverCode:t.status}))})}),u.promise}};return l}(),t.api.Zone=function(){var e=t.util.Api,r=t.Validation,n=t.Deferred,o=t.store.Session,i=t.Tag,s=t.Zone,a=null,c=function(e){var n={};if(!e)return n;if(e.id||e.ids){var o=e.ids?e.ids:[];e.id&&o.push(e.id),n.ids=o.join(";")}if(e.tag||e.tags){var s=e.tags?e.tags.map(function(e){if(e instanceof i)return e.id;throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tags"})}):[];if(e.tag){if(!(e.tag instanceof i))throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tag"});s.push(e.tag.id)}n.tagIds=s.join(";")}if(e.tagID||e.tagIDs){var s=e.tagIDs?e.tagIDs:[];e.tagID&&s.push(e.tagID),n.tagIds=n.tagIds?Array.prototype.push.apply(n.tagIds,s.join(";")):s.join(";")}if(e.location){if(!e.location.lat||!e.location.lng)throw(new r).addError("Missing Argument","location request parameter object must contain a lat and lng property.",{code:r.type.MISSINGARG,context:"location.lat,location.lng"});n.Location=e.location.lat+","+e.location.lng,e.location.range&&(n.Location+=","+e.location.range)}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new r).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:r.type.MISSINGARG,context:"paging.limit,paging.offset"});e.paging.limit&&(n.limit=e.paging.limit),e.paging.offset&&(n.offset=e.paging.offset)}if(e.orderBy){var a=e.orderBy.key;if(!a)throw(new r).addError("Missing Argument","orderBy requires a zone model property key to order by.",{code:r.type.MISSINGARG,context:"orderBy.key"});if(!t.Zone.reqKeys[a])throw(new r).addError("Invalid Argument","Zone does not contain or cannot be ordered by this property:"+a,{code:r.type.INVALIDARG,context:"orderBy.key"});a=t.Zone.reqKeys[a];var c=e.orderBy.direction?e.orderBy.direction:"ascending";n.orderby=a+":"+c}if(e.search){for(var u=Object.keys(e.search),l=u.length,d={},p=[],f=new r;l--;){var h=u[l],g=e.search[h];t.Zone.reqKeys[h]||f.addError("Invalid Argument","Zone does not contain or cannot be searched by this property:"+h,{code:r.type.INVALIDARG,context:"search"}),h=t.Zone.reqKeys[h],d[g]?d[g]+=";"+h:d[g]=h}if(!f.state)throw f;for(var m=Object.keys(d),y=m.length;y--;){var v=m[y],I=d[v];p.push(v+":"+I)}n.search="search="+p.join("&search=")}return n},u={getPaging:function(){return a},logConnect:function(i){var s=new n,a=t.cfg.HOST+t.cfg.res.ZONECONNECT.replace("{zid}",i),c=o.deviceID,u=new r;if(i||u.addError("Missing Argument","No Zone ID was provided.",{code:r.type.MISSINGARG,context:"zid"}),c||u.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!u.state)throw u;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);s.reject((new r).addError("Connection log failed.",o,{serverCode:t.status}))})}),s.promise},logDisconnect:function(i){var s=new n,a=t.cfg.HOST+t.cfg.res.ZONEDISCONNECT.replace("{zid}",i),c=o.deviceID,u=new r;if(i||u.addError("Missing Argument","No Zone ID was provided.",{code:r.type.MISSINGARG,context:"zid"}),c||u.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!u.state)throw u;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);s.reject((new r).addError("Disconnection log failed.",o,{serverCode:t.status}))})}),s.promise},getZone:function(e){var t=this,o=new n;if(!e||""===e)throw(new r).addError("Missing Argument","No Zone ID specified",{code:r.type.MISSINGARG,context:"id"});return this.getZones({id:e}).then(function(e){var n=e.result;n.length<=0&&0===t.getPaging().total?o.reject((new r).addError("Model Not Found","A Zone was not found with the supplied ID",{code:r.type.NOTFOUND,context:"id"})):n.length>0&&o.resolve(n[0])})["catch"](function(e){o.reject(e)}),o.promise},getZones:function(i){var u=new n,l=t.cfg.HOST+t.cfg.res.ZONES,d=c(i),p=o.deviceID;return d.search&&(l+="?"+d.search,delete d.search),d=e.toURLParams(d),""!==d&&(l+=l.indexOf("?")<0?"?":"&",l+=d.toString()),fetch(l,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(n){try{var o=e.parseResponse(n),c=e.parsePaging(o);a=c}catch(l){u.reject((new r).addError("Request Failed","Unexpected server response.",{code:r.type.MALFORMED}))}if(o&&o.data&&o.data.length>=0){var d=o.data.map(function(e){try{return new s(e)}catch(t){u.reject((new r).addError("Request Failed","Failed to parse server model.",{code:r.type.MALFORMED,context:e}))}});u.resolve({result:d,nextPageFn:e.createNextPageCall(t.api.Zone.getZones,i,c)})}else u.reject((new r).addError("Zones retrieval failed","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);u.reject((new r).addError("Zones retrieval failed",o,{serverCode:t.status}))})}),u.promise}};return u}(),t.api.ZoneMomentInstance=function(){var e=t.util.Api,r=t.Validation,n=t.Deferred,o=t.store.Session,i=t.Tag,s=t.ZoneMomentInstance,a=null,c=function(e){var t={};if(!e)return t;if(e.id||e.ids){var n=e.ids?e.ids:[];e.id&&n.push(e.id),t.ids=n.join(";")}if(e.zid||e.zids){var o=e.zids?e.zids:[];e.zid&&o.push(e.zid),t.zoneids=o.join(";")}if(e.tag||e.tags){var a=e.tags?e.tags.map(function(e){if(e instanceof i)return e.id;throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tags"})}):[];if(e.tag){if(!(e.tag instanceof i))throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tag"});a.push(e.tag.id)}t.tagIds=a.join(";")}if(e.tagID||e.tagIDs){var a=e.tagIDs?e.tagIDs:[];e.tagID&&a.push(e.tagID),t.tagIds=t.tagIds?Array.prototype.push.apply(t.tagIds,a.join(";")):a.join(";")}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new r).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:r.type.MISSINGARG});e.paging.limit&&(t.limit=e.paging.limit),e.paging.offset&&(t.offset=e.paging.offset)}if(e.orderBy){var c=e.orderBy.key;if(!c)throw(new r).addError("Missing Argument","orderBy requires a ZoneMomentInstance model property key to order by.",{code:r.type.MISSINGARG,context:"orderBy.key"});if(!s.reqKeys[c])throw(new r).addError("Invalid Argument","ZoneMomentInstance does not contain or cannot be ordered by this property:"+c,{code:r.type.INVALIDARG,
context:"orderBy.key"});c=s.reqKeys[c];var u=e.orderBy.direction?e.orderBy.direction:"ascending";t.orderby=c+":"+u}if(e.search){for(var l=Object.keys(e.search),d=l.length,p={},f=[],h=new r;d--;){var g=l[d],m=e.search[g];s.reqKeys[g]||h.addError("Invalid Argument","ZoneMomentInstance does not contain or cannot be searched by this property:"+g,{code:r.type.INVALIDARG,context:"search"}),g=s.reqKeys[g],p[m]?p[m]+=";"+g:p[m]=g}if(!h.state)throw h;for(var y=Object.keys(p),v=y.length;v--;){var I=y[v],E=p[I];f.push(I+":"+E)}t.search="search="+f.join("&search=")}return t},u={getPaging:function(){return a},logConnect:function(i){var s=new n,a=t.cfg.HOST+t.cfg.res.ZMICONNECT.replace("{zmiID}",i),c=o.deviceID,u=new r;if(i||u.addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"zmiID"}),c||u.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!u.state)throw u;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);s.reject((new r).addError("Connection log failed.",o,{serverCode:t.status}))})}),s.promise},logDisconnect:function(i){var s=new n,a=t.cfg.HOST+t.cfg.res.ZMIDISCONNECT.replace("{zmiID}",i),c=o.deviceID,u=new r;if(i||u.addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"zmiID"}),c||u.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!u.state)throw u;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);s.reject((new r).addError("Disconnection log failed.",o,{serverCode:t.status}))})}),s.promise},getZMI:function(e){var t=this,o=new n;if(!e||""===e)throw(new r).addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"id"});return this.getZMIs({id:e}).then(function(e){var n=e.result;n.length<=0&&0===t.getPaging().total?o.reject((new r).addError("Model Not Found","A ZoneMomentInstance was not found with the supplied ID",{code:r.type.NOTFOUND,context:"id"})):n.length>0&&o.resolve(n[0])})["catch"](function(e){o.reject(e)}),o.promise},getZMIs:function(i){var u=new n,l=t.cfg.HOST+t.cfg.res.ZMIS,d=c(i),p=o.deviceID;return d.search&&(l+="?"+d.search,delete d.search),d=e.toURLParams(d),""!==d&&(l+=l.indexOf("?")<0?"?":"&",l+=d.toString()),fetch(l,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(n){try{var o=e.parseResponse(n),c=e.parsePaging(o);a=c}catch(l){u.reject((new r).addError("Request Failed","Unexpected server response.",{code:r.type.MALFORMED}))}if(o&&o.data&&o.data.length>=0){var d=o.data.map(function(e){try{return new s(e)}catch(t){u.reject((new r).addError("Request Failed","Failed to parse server model.",{code:r.type.MALFORMED,context:e}))}});u.resolve({result:d,nextPageFn:e.createNextPageCall(t.api.ZoneMomentInstance.getZMIs,i,c)})}else u.reject((new r).addError("ZoneMomentInstances retrieval failed","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);u.reject((new r).addError("ZoneMomentInstances retrieval failed",o,{serverCode:t.status}))})}),u.promise},getAccessToken:function(i){var s=new n,a=t.cfg.HOST+t.cfg.res.ZMIJWT.replace("{zmiID}",i),c=o.deviceID;if(!i)throw(new r).addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"zmiID"});return fetch(a,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var n=e.parseResponse(t)}catch(o){s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.","Unexpected server response.",{code:r.type.MALFORMED}))}n&&n.payload?s.resolve(n.payload):s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(n){var o=e.parseErrorMsg(n);return o&&"ZoneMomentInstanceNotFoundException"===o.exceptionType?void s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.","ZoneMomentInstance with provided ID was not found.",{code:r.type.NOTFOUND,context:"zmiID"})):void s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.",o,{serverCode:t.status}))})}),s.promise}};return u}(),"object"==typeof window)window.Flybits=t,t.init=t.init.browser,t.store.Property=t.store.Property.browser,t.context=r,t.analytics=n;else if("object"==typeof exports&&"undefined"!=typeof module){var h=require("fs"),g=require("node-persist");t.init=t.init.server,t.store.Property=t.store.Property.server,module.exports=t}else"function"==typeof define&&define.amd?define(function(){return t.init=t.init.server,t.store.Property=t.store.Property.server,t}):(t.init=t.init.server,t.store.Property=t.store.Property.server,global.Flybits=t);"string"==typeof __dirname&&(t.cfg.store.RESOURCEPATH=__dirname+"/../res/"),t.store.Property.init();var m=new t.Deferred;t.ready=m.promise}();