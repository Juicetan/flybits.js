// @author Justin Lam
// @version feature/abstractedStorage:ea17a8e
!function(e){var t={ready:null,store:{Property:{}},api:{},init:{},util:{},"interface":{}},r={};t.cfg={HOST:"http://tenant.flybits.com/v2",CTXHOST:"https://gateway.flybits.com/ctxdata",APIKEY:"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",CTXREPORTDELAY:6e4,store:{SDKPROPS:"flb.sdk.properties",RESOURCEPATH:"./res/",DEVICEID:"flb_device",USERTOKEN:"flb_usertoken",USERTOKENEXP:"flb_usertoken_expiry"},res:{TAGS:"/Tags",USERS:"/Users",ZONES:"/Zones",ZONECONNECT:"/Zones/{zid}/Connect",ZONEDISCONNECT:"/Zones/{zid}/Disconnect",ZMIS:"/ZoneMomentInstances",ZMIJWT:"/ZoneMomentInstances/{zmiID}/jwt",ZMICONNECT:"/ZoneMomentInstances/{zmiID}/Connect",ZMIDISCONNECT:"/ZoneMomentInstances/{zmiID}/Disconnect",LOGIN:"/Users/Login",LOGOUT:"/Users/Logout",REGISTER:"/Users/Register",CHANGEPASS:"/Users/ChangePassword",SETREMEMBERME:"/Users/rememberMe"},coreMoments:{"com.flybits.moments.website":"native","com.flybits.moments.text":"native"}},t.VERSION="feature/abstractedStorage:ea17a8e";var o=function(e){var r=new t.Deferred;return fetch(e).then(function(r){if(200!==r.status)throw(new t.Validation).addError("Configuration file not found","Reverting to default configuration. No configuration found at:"+e,{code:t.Validation.type.INVALIDARG,context:"url"});return r.json()}).then(function(e){t.util.Obj.extend(t.cfg,e),r.resolve(t.cfg)})["catch"](function(o){o instanceof t.Validation?r.reject(o):r.reject((new t.Validation).addError("Failed to read configuration file.","Reverting to default configuration. Configuration format incorrect at:"+e,{code:t.Validation.type.MALFORMED,context:"url"}))}),r.promise},n=function(e){if(!e)return console.log("> config file path not provided: using defaults"),!1;try{var r=u.readFileSync(e)}catch(o){throw new Error("Config file read failed: "+e)}try{t.util.Obj.extend(t.cfg,JSON.parse(r))}catch(o){throw new Error("Malformed Config file: "+e)}},i=function(){var e=new t.Deferred,r=t.store.Property;return r.get(t.cfg.store.DEVICEID).then(function(e){if(e)return t.store.Session.deviceID=e,e;var o=t.util.Obj.guid();return t.store.Session.deviceID=o,r.set(t.cfg.store.DEVICEID,o)}).then(function(t){e.resolve()})["catch"](function(t){e.reject(t)}),e.promise},s=function(){t.context&&(t.context.Manager.reportDelay=t.cfg.CTXREPORTDELAY)};t.init.server=function(e){return n(e),i().then(function(){s(),p.resolve(t.cfg)})["catch"](function(e){p.reject(e)}),t.ready},t.init.browser=function(e){return o(e).then(function(){return i()}).then(function(){s(),p.resolve(t.cfg)})["catch"](function(e){p.reject(e)}),t.ready},t.initObj=function(e){return t.util.Obj.extend(t.cfg,e),i().then(function(){s(),p.resolve(t.cfg)})["catch"](function(e){p.reject(e)}),t.ready},t.Deferred=function(){Promise.settle=function(e){var t=e.map(function(e){return e.then(function(e){return{result:e,status:"resolved"}},function(e){return{result:e,status:"rejected"}})});return Promise.all(t)};var e=function(){var e=this;this.promise=new Promise(function(t,r){e.resolve=t,e.reject=r}),this.then=this.promise.then.bind(this.promise),this["catch"]=this.promise["catch"].bind(this.promise)};return e}(),t.util.Api=function(){var t={checkResult:function(e){if(e.status>=200&&e.status<300)return e;throw e},getResultStr:function(e){return e&&e.text?e.text():new Promise(function(e,t){e("")})},getResultJSON:function(e){return e.json()},toURLParams:function(e){for(var t=Object.keys(e),r=t.length,o="";r--;){var n=t[r];""!==o&&(o+="&"),o+=n+"="+encodeURIComponent(e[n])}return o},htmlEncode:function(e){return encodeURIComponent(e)},htmlDecode:function(t){return t.replace(/&#?(\w+);/g,function(t,r){return isNaN(r)&&(chars={quot:34,amp:38,lt:60,gt:62,nbsp:160,copy:169,reg:174,deg:176,frasl:47,trade:8482,euro:8364,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,permil:8240,lsaquo:8249,rsaquo:8250,spades:9824,clubs:9827,hearts:9829,diams:9830,oline:8254,larr:8592,uarr:8593,rarr:8594,darr:8595,hellip:133,ndash:150,mdash:151,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,brkbar:166,sect:167,uml:168,die:168,ordf:170,laquo:171,not:172,shy:173,macr:175,hibar:175,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Alpha:913,alpha:945,Beta:914,beta:946,Gamma:915,gamma:947,Delta:916,delta:948,Epsilon:917,epsilon:949,Zeta:918,zeta:950,Eta:919,eta:951,Theta:920,theta:952,Iota:921,iota:953,Kappa:922,kappa:954,Lambda:923,lambda:955,Mu:924,mu:956,Nu:925,nu:957,Xi:926,xi:958,Omicron:927,omicron:959,Pi:928,pi:960,Rho:929,rho:961,Sigma:931,sigma:963,Tau:932,tau:964,Upsilon:933,upsilon:965,Phi:934,phi:966,Chi:935,chi:967,Psi:936,psi:968,Omega:937,omega:969},chars[r]!==e&&(r=chars[r])),String.fromCharCode(r)})},base64Decode:function(e){return decodeURIComponent(Array.prototype.map.call(atob(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},parseResponse:function(e){return JSON.parse(e,function(e,r){return"string"==typeof r?t.htmlDecode(r):r})},parseErrorMsg:function(e){try{var t=this.parseResponse(e)}catch(r){return"Malformed server response"}var o=null;return t?t.messageJSON||t.exceptionMessage||t.message||"Unexpected error has occurred":o},parsePaging:function(e){return{offset:e.pagination.offset,limit:e.pagination.limit,total:e.pagination.totalRecords}},createNextPageCall:function(e,t,r){return r.offset+r.limit>=r.total?null:(t=t?t:{},function(){return t.paging={limit:r.limit,offset:r.offset+r.limit},e(t)})}};return t}(),t.util.Browser=function(){var e=(t.Deferred,{getCookie:function(e){var t="; "+document.cookie,r=t.split("; "+e+"=");return 2==r.length?r.pop().split(";").shift():null},setCookie:function(e,t,r){var o="";r&&(o="; expires="+r.toGMTString()),document.cookie=e+"="+t+o+"; path=/"}});return e}(),t.util.Geo=function(){var e={_toDeg:function(e){return 180*e/Math.PI},_toRad:function(e){return e*Math.PI/180},getBoundingBox:function(e){if(!e||e.length<3)throw(new t.Validation).addError("Invalid Argument","Must provide an array of lat,lng coordinates greater than 2.",{code:t.Validation.type.INVALIDARG});for(var r=e[0].lat,o=e[0].lat,n=e[0].lng,i=e[0].lng,s=1;s<e.length;s++){var a=e[s];r=a.lat<r?a.lat:r,o=a.lat>o?a.lat:o,n=a.lng<n?a.lng:n,i=a.lng>i?a.lng:i}return{min:{lat:r,lng:n},max:{lat:o,lng:i}}},getCenter:function(e){if(!e||e.length<3)throw(new t.Validation).addError("Invalid Argument","Must provide an array of lat,lng coordinates greater than 2.",{code:t.Validation.type.INVALIDARG});var r=this.getBoundingBox(e);return{lat:(r.max.lat+r.min.lat)/2,lng:(r.max.lng+r.min.lng)/2}},getBearing:function(e,t){var r=t.lng-e.lng,o=Math.sin(r)*Math.cos(t.lat),n=Math.cos(e.lat)*Math.sin(t.lat)-Math.sin(e.lat)*Math.cos(t.lat)*Math.cos(r),i=this._toDeg(Math.atan2(o,n));return 360-(i+360)%360}};return e}(),t.util.Obj=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t={extend:function(e,t){if("function"==typeof $&&"function"==typeof $.extend)return $.extend(!0,e,t);if("function"==typeof _&&"function"==typeof _.extend)return _.extend(e,t);for(var r in t)t[r]&&t[r].constructor&&t[r].constructor===Object?(e[r]=e[r]||{},arguments.callee(e[r],t[r])):e[r]=t[r];return e},guid:function(t){var r="js";if(t&&t>0){for(var o=0;o<t;o++)r+="js"!==r?"-"+e():e();return r}return"js"+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},removeObject:function(e,t,r){var o=e.indexOf(t);if(r){var n=e.filter(r);n.length>0&&(o=e.indexOf(n[0]))}return o>=0?e.splice(o,1):e}};return t}(),t["interface"].ContextPlugin={isSupported:function(){},getState:function(){},_toServerFormat:function(e){}},t["interface"].Localizable={_fromLocaleJSON:function(e){},_toLocaleJSON:function(e){}},t["interface"].PropertyStore={isSupported:function(){},getItem:function(e){},setItem:function(e,t){},removeItem:function(e){}},t["interface"].Serializable={fromJSON:function(e){},toJSON:function(){}},t["interface"].Taggable={hasTag:function(e){},getTags:function(){}};var a=function(){var e=function(){};return e.prototype={"implements":function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),c=function(){var e=function(e){a.call(this),this.id=null,e&&(this.id=e.id)};return e.prototype=Object.create(a.prototype),e.prototype.constructor=e,e.prototype.reqKeys={id:"id"},e}();t.Moment=function(){var e=function(e){c.call(this,e),e&&this.fromJSON(e)};return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype["implements"]("Serializable"),e.prototype.MASK_ANDROID=e.MASK_ANDROID=2,e.prototype.MASK_IOS=e.MASK_IOS=1,e.prototype.RENDERTYPE_NATIVE=e.RENDERTYPE_NATIVE="native",e.prototype.RENDERTYPE_HTML=e.RENDERTYPE_HTML="html",e.prototype.RENDERTYPE_NONE=e.RENDERTYPE_NONE="none",e.prototype.fromJSON=function(e){this.name=e.name,this.icon=e.icon,this.baseNotifyURL=e.notifyUrl,this.manageURL=e.editUrl,this.clientURL=e.launchUrl,this.androidPkg=e.androidPackageName,this.iosPkg=e.iosPackageName,this.privateKey=e.sharedKey,this.ownerID=e.ownerId,this.status=e.status,this.type=e.type,this.isProduction=e.isProduction,this.renderType=e.renditionType,this.supportedDevices=e.supportedDeviceType},e.prototype.toJSON=function(){var e={name:this.name,icon:this.icon,notifyUrl:this.baseNotifyURL,editUrl:this.manageURL,launchUrl:this.clientURL,androidPackageName:this.androidPkg,iosPackageName:this.iosPkg,sharedKey:this.privateKey,ownerId:this.ownerID,status:this.status,type:this.type,isProduction:this.isProduction,renditionType:this.renderType,supportedDeviceType:this.supportedDevices};return this.id&&(e.id=this.id),e},e}(),t.MomentInstance=function(){var e=function(e){c.call(this,e),e&&this.fromJSON(e)};return e.prototype=Object.create(c.prototype),e.prototype.constructor=e,e.prototype["implements"]("Serializable"),e.prototype["implements"]("Localizable"),e.prototype._fromLocaleJSON=function(e){var t={name:e.name,desc:e.description,icon:e.icon};return t},e.prototype._toLocaleJSON=function(e){var t={name:e.name,description:e.desc,icon:e.icon};return t},e.prototype.fromJSON=function(e){var t=this;this.momentID=e.momentId,this.isConfirmed=e.isConfirmed,this.defaultLang=e.defaultLanguage,this.metadata=e.metadata,this.locales={};var r=e.localizations?Object.keys(e.localizations):[];r.forEach(function(r){t.locales[r]=t._fromLocaleJSON(e.localizations[r])}),r.length>0&&this.defaultLang&&(this.defaultLocaleObj=this.locales[this.defaultLang])},e.prototype.toJSON=function(){var e=this,t={momentId:this.momentID,isConfirmed:this.isConfirmed,defaultLanguage:this.defaultLang,metadata:this.metadata,localizations:{}};if(this.id&&(t.id=this.id),this.locales&&Object.keys(this.locales).length>0){var r=Object.keys(this.locales);r.forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])})}return t},e}(),t.Tag=function(){var e=t.util.Obj,r=function(e){c.call(this,e),e&&this.fromJSON(e)};return r.prototype=Object.create(c.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype["implements"]("Localizable"),r.prototype.reqKeys=r.reqKeys=e.extend({label:"value",icon:"icon",isVisible:"isVisible"},c.prototype.reqKeys),r.prototype._fromLocaleJSON=function(e){var t={label:e.value,icon:e.icon};return t},r.prototype._toLocaleJSON=function(e){var t={value:e.label,icon:e.icon};return t},r.prototype.fromJSON=function(e){var t=this;this.isVisible=e.isVisible,this.defaultLang=e.defaultLanguage,this.zoneIDs=e.zoneIds?e.zoneIds:[],this.zmiIDs=e.zoneMomentInstanceIds?e.zoneMomentInstanceIds:[],this.locales={};var r=e.localizations?Object.keys(e.localizations):[];r.forEach(function(r){t.locales[r]=t._fromLocaleJSON(e.localizations[r])}),r.length>0&&this.defaultLang&&(this.defaultLocaleObj=this.locales[this.defaultLang])},r.prototype.toJSON=function(){var e=this,t={isVisible:this.isVisible,defaultLanguage:this.defaultLang,zoneIds:this.zoneIDs,zoneMomentInstanceIds:this.zmiIDs,localizations:{}};if(this.id&&(t.id=this.id),Object.keys(this.locales).length>0){var r=Object.keys(this.locales);r.forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])})}return t},r}(),t.User=function(){var e=t.util.Obj,r=function(e){c.call(this,e),e&&this.fromJSON(e)};return r.prototype=Object.create(c.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype.reqKeys=r.reqKeys=e.extend({email:"email",firstName:"firstName",lastName:"lastName",profileImg:"icon"},c.prototype.reqKeys),r.prototype.fromJSON=function(e){this.email=e.email,this.firstName=e.firstName,this.lastName=e.lastName,this.profileImg=e.icon,e.credentialsJwt&&(this._authToken=e.credentialsJwt)},r.prototype.toJSON=function(){var e={email:this.email,firstName:this.firstName,lastName:this.lastName,icon:this.profileImg};return this.id&&(e.id=this.id),e},r}(),t.Validation=function(){var e=function(){this.state=!0,this.errors=[]};return e.prototype.type=e.type={},e.prototype.type.MALFORMED=e.type.MALFORMED=1e3,e.prototype.type.INVALIDARG=e.type.INVALIDARG=1001,e.prototype.type.MISSINGARG=e.type.MISSINGARG=1002,e.prototype.type.NOTFOUND=e.type.NOTFOUND=1003,e.prototype.type.CONNECTIONERROR=e.type.CONNECTIONERROR=1004,e.prototype.type.UNAUTHENTICATED=e.type.UNAUTHENTICATED=1005,e.prototype.type.RETRIEVALERROR=e.type.RETRIEVALERROR=1006,e.prototype.type.NOTSUPPORTED=e.type.NOTSUPPORTED=1007,e.prototype.type.UNEXPECTED=e.type.UNEXPECTED=1008,e.prototype={addError:function(e,t,r){this.state=!1;var o={header:e,message:t};return r&&(o.context=r.context,o.code=r.code,o.serverCode=r.serverCode),this.errors.push(o),this},firstError:function(){return this.errors.length>0?this.errors[0]:null}},e}(),t.Zone=function(){var e=t.util.Obj,r=function(e){c.call(this,e),e&&this.fromJSON(e)};return r.prototype=Object.create(c.prototype),r.prototype.constructor=r,r.prototype["implements"]("Serializable"),r.prototype["implements"]("Localizable"),r.prototype["implements"]("Taggable"),r.prototype.reqKeys=r.reqKeys=e.extend({creatorID:"creatorId",isPublished:"isPublished",name:"name",description:"description",icon:"coverImg"},c.prototype.reqKeys),r.prototype._fromLocaleJSON=function(e){var t={name:e.name,description:e.description,coverImg:e.icon};return t},r.prototype._toLocaleJSON=function(e){var t={name:e.name,description:e.description,icon:e.coverImg};return t},r.prototype.fromJSON=function(e){var t=this;this.creatorID=e.creatorId,this.geofence=e.shapes,this.isPublished=e.isPublished,this.defaultLang=e.defaultLanguage,this.timeZone=e.timeZone,this.metadata=e.metadata,e.analytics&&(this.stats={visits:e.analytics.totalUserVisits,favourited:e.analytics.favoriteCount,momentCount:e.analytics.zoneMomentCount}),e.activeUserRelationship&&(this.userContextStats={isFavourite:e.activeUserRelationship.isFavorite,zoneCenterDistance:e.activeUserRelationship.distanceToZoneCenter,zoneEdgeDistance:e.activeUserRelationship.distanceToZoneEdge,isInZone:e.activeUserRelationship.isInsideZone}),e.tagIds&&e.tagIds.items.length>0?this.tagIDs=e.tagIds.items:this.tagIDs=[],this.locales={};var r=e.localizations?Object.keys(e.localizations):[];r.forEach(function(r){t.locales[r]=t._fromLocaleJSON(e.localizations[r])}),r.length>0&&this.defaultLang&&(this.defaultLocaleObj=this.locales[this.defaultLang])},r.prototype.toJSON=function(){var e=this,t={creatorId:this.creatorID,shapes:this.geofence,isPublished:this.isPublished,defaultLanguage:this.defaultLang,metadata:this.metadata,timeZone:this.timeZone,localizations:{}};if(this.stats&&(t.analytics={totalUserVisits:this.stats.visits,favoriteCount:this.stats.favourited,zoneMomentCount:this.stats.momentCount}),this.userContextStats&&(t.activeUserRelationship={isFavorite:this.userContextStats.isFavourite,distanceToZoneCenter:this.userContextStats.zoneCenterDistance,distanceToZoneEdge:this.userContextStats.zoneEdgeDistance,isInsideZone:this.userContextStats.isInZone}),this.tagIDs&&(t.tagIds={items:this.tagIDs,numItems:this.tagIDs.length}),this.id&&(t.id=this.id),Object.keys(this.locales).length>0){var r=Object.keys(this.locales);r.forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])})}return t},r.prototype.hasTag=function(e){for(var t=this,r=this.tagIDs.length,o=!1;r--;)if(t.tagIDs[r]===e){o=!0;break}return o},r.prototype.getTags=function(){return t.api.Tag.getTags({ids:this.tagIDs})},r}(),t.ZoneMomentInstance=function(){var e=t.MomentInstance,r=t.Moment,o=t.util.Obj,n=t.Validation,i=t.Deferred,s=t.cfg,a=function(e){c.call(this,e),e&&this.fromJSON(e)};return a.prototype=Object.create(c.prototype),a.prototype.constructor=a,a.prototype["implements"]("Serializable"),a.prototype["implements"]("Taggable"),a.prototype.reqKeys=a.reqKeys=o.extend({isAutoRun:"isAutoRun",isPublished:"isPublished",name:"name",supportedDevices:"supportedDeviceType",renderType:"renditionType"},c.prototype.reqKeys),a.prototype.fromJSON=function(t){this.zoneID=t.zoneId,this.momentInstanceID=t.momentInstanceId,this.isAutoRun=t.isAutoRun,this.order=t.order,this.isPublished=t.isPublished,t.auxiliaryAncestorProperties&&(this.momentInstance=new e(t.auxiliaryAncestorProperties),this.momentInstance.id=this.momentInstanceID,this.moment=new r(t.auxiliaryAncestorProperties),this.moment.id=this.momentInstance.momentID),this.tagIDs=t.tagIds?t.tagIds:[]},a.prototype.toJSON=function(){var e={};this.momentInstance&&(e=o.extend(e,this.momentInstance.toJSON())),this.moment&&(e=o.extend(e,this.moment.toJSON()));var t={zoneId:this.zoneID,momentInstanceId:this.momentInstanceID,isAutoRun:this.isAutoRun,order:this.order,isPublished:this.isPublished,auxiliaryAncestorProperties:e,tagIds:this.tagIDs};return this.id&&(t.id=this.id),t},a.prototype.getAccessToken=function(){if(!this.id)throw(new n).addError("Malformed Model","This ZoneMomentInstance is missing an ID.",{code:n.type.MALFORMED,context:"id"});return t.api.ZoneMomentInstance.getAccessToken(this.id)},a.prototype.getRenderType=function(){if(!this.moment)throw(new n).addError("Malformed Model","This ZoneMomentInstance is missing a Moment object and its renderType.",{code:n.type.MALFORMED,context:"moment"});return this.moment.renderType},a.prototype.isCoreMoment=function(){if(this.moment){var e=this.moment.androidPkg||this.moment.iosPkg;return s.coreMoments[e]}return!1},a.prototype.getClientURL=function(){var e=this,t=new i,o=this.getRenderType();return o!==r.RENDERTYPE_HTML&&this.isCoreMoment()?this.getAccessToken().then(function(r){var o=e.moment.manageURL+"/m.html?payload="+r;t.resolve(o)})["catch"](function(e){t.reject(e)}):o!==r.RENDERTYPE_HTML?t.reject((new n).addError("Not Supported","HTML user interface does not exist.",{context:"moment.renderType",code:n.type.NOTSUPPORTED})):this.getAccessToken().then(function(r){var o=e.moment.clientURL+"?payload="+r;t.resolve(o)})["catch"](function(e){t.reject(e)}),t.promise},a.prototype.hasTag=function(e){for(var t=this,r=this.tagIDs.length,o=!1;r--;)if(t.tagIDs[r]===e){o=!0;break}return o},a.prototype.getTags=function(){return t.api.Tag.getTags({ids:this.tagIDs})},a}(),t.store.Property.browser=function(){var e=t.Deferred,r=null,o={init:function(){window.localforage&&window.localforage._driver?r=window.localforage.createInstance({name:t.cfg.store.SDKPROPS}):window.localStorage&&(r=window.localStorage)},localDump:{},isLocalStoreSupported:function(){var e=window.localforage&&window.localforage._driver||window.localStorage;if(!e)return!1;try{return localStorage.setItem("support",!0),localStorage.removeItem("support"),!0}catch(t){return!1}},remove:function(t){var o=new e,n=this;if(this.isLocalStoreSupported())try{var i=r.removeItem(t);i?i.then(function(){o.resolve(n)})["catch"](function(e){o.reject(e)}):o.resolve(n)}catch(s){console.error(s),o.reject(s)}else console.error("> WARNING: `localStorage` not supported on this platform. Reverting to temporary in memory storage."),delete this.localDump[t],o.resolve(n);return o.promise},set:function(t,o){var n=new e,i=this;if(!o)return i.remove(t);if(this.isLocalStoreSupported())try{var s=r.setItem(t,o);s?s.then(function(){n.resolve(i)})["catch"](function(e){n.reject(e)}):n.resolve(i)}catch(a){console.error(a),n.reject(a)}else console.error("> WARNING: `localStorage` not supported on this platform. Reverting to temporary in memory storage."),this.localDump[t]=o,n.resolve(i);return n.promise},get:function(t){var o=new e;if(this.isLocalStoreSupported()){var n=r.getItem(t);n&&n instanceof Promise?n.then(function(e){o.resolve(e)})["catch"](function(e){o.reject(e)}):o.resolve(n)}else{console.error("> WARNING: `localStorage` not supported on this platform. Reverting to temporary in memory storage.");var i=this.localDump[t];o.resolve(i)}return o.promise}};return o}(),t.store.Property.server=function(){var e,r=t.Deferred,o={init:function(){e=l.create({dir:t.cfg.store.RESOURCEPATH}),e.initSync()},remove:function(t){var o=new r,n=this;return e.removeItem(t).then(function(){o.resolve(n)})["catch"](function(e){o.reject(e)}),o.promise},set:function(t,o){var n=new r,i=this;return o?(e.setItem(t,o).then(function(){n.resolve(i)})["catch"](function(e){n.reject(e)}),n.promise):this.remove(t)},get:function(t){var o=new r;return e.getItem(t).then(function(e){o.resolve(e)})["catch"](function(e){o.reject(e)}),o.promise}};return o}(),t.store.Session=function(){var e=(t.util.Browser,t.util.Api),r=t.Validation,o=t.Deferred,n=t.cfg,i={constants:{REMEMBERME:"_rememberMe"},user:null,deviceID:null,userToken:null,_userTokenRetrievedAt:null,_userTokenExpiry:null,hasRememberMe:function(){return t.store.Property.get(n.store.REMEMBERME)},resolveSession:function(e){var n=this,i=new o;return e?(this.user?i.resolve(this.user):i.reject((new r).addError("Session not found.","",{code:r.type.UNAUTHENTICATED})),i.promise):(t.api.User.getAccessToken().then(function(e){i.resolve(n.user)})["catch"](function(e){var t=e.firstError();t&&t.serverCode&&(403===t.serverCode||401===t.serverCode)?(n.clearSession(),i.reject((new r).addError("Session not found.","",{code:r.type.UNAUTHENTICATED}))):i.reject(e)}),i.promise)},setUserToken:function(r){if(this.userToken=r,r){var o=e.base64Decode(r.split(".")[1]),i=JSON.parse(o);this._userTokenExpiry=i.expiresAt?1e3*i.expiresAt:0,this._userTokenRetrievedAt=(new Date).getTime(),t.store.Property.set(n.store.USERTOKEN,r),t.store.Property.set(n.store.USERTOKENEXP,this._userTokenExpiry)}else t.store.Property.set(n.store.USERTOKEN,null),t.store.Property.set(n.store.USERTOKENEXP,null),this._userTokenExpiry=null,this._userTokenRetrievedAt=null},setSession:function(e){this.user=e,e._authToken&&this.setUserToken(e._authToken)},clearSession:function(){this.user=null,this.setUserToken(null)}};return i}();var d=(function(){var e=t.Deferred,r=(t.Validation,t.util.Browser),o=function(){a.call(this)};return o.prototype=Object.create(a.prototype),o.prototype.constructor=o,o.prototype["implements"]("PropertyStore"),o.prototype.isSupported=o.isSupported=function(){var t=new e,o=document&&"cookie"in document;if(o)try{r.setCookie("support","true"),r.setCookie("support","true",new Date(0)),t.resolve()}catch(n){t.reject()}else t.reject();return t.promise},o.prototype.getItem=function(e){return r.getCookie(e)},o.prototype.setItem=function(e,t){return r.setCookie(e,t)},o.prototype.removeItem=function(e){return r.setCookie(e,"",new Date(0))},d}(),function(){var e=t.Deferred,r=(t.Validation,function(e){a.call(this),this.store=localforage.createInstance({name:e})});return r.prototype=Object.create(a.prototype),r.prototype.constructor=r,r.prototype["implements"]("PropertyStore"),r.prototype.isSupported=r.isSupported=function(){var t=new e,r=window&&window.localforage&&window.localforage._driver;return r?localforage.setItem("support",!0).then(function(){return localforage.removeItem("support")}).then(function(){t.resolve()})["catch"](function(e){t.reject()}):t.reject(),t.promise},r.prototype.getItem=function(e){return this.store.getItem(e)},r.prototype.setItem=function(e,t){return this.store.setItem(e,t)},r.prototype.removeItem=function(e){return this.store.removeItem(e)},r}());(function(){var e=t.Deferred,r=(t.Validation,function(){a.call(this),this.store=localStorage});return r.prototype=Object.create(a.prototype),r.prototype.constructor=r,r.prototype["implements"]("PropertyStore"),r.prototype.isSupported=r.isSupported=function(){var t=new e,r=window&&window.localStorage;if(r)try{localStorage.setItem("support",!0),localStorage.removeItem("support"),t.resolve()}catch(o){t.reject()}else t.reject();return t.promise},r.prototype.getItem=function(e){return this.store.getItem(e)},r.prototype.setItem=function(e,t){return this.store.setItem(e,t)},r.prototype.removeItem=function(e){return this.store.removeItem(e)},d})();if(r.Manager=function(){var e=t.Deferred,o=t.Validation,n=t.util.Obj,i=t.util.Api,s=t.store.Session,a={services:[],reportDelay:6e4,_reportTimeout:null,isReporting:!1,register:function(t){var n=this,i=new e;return t instanceof r.ContextPlugin?(t.isSupported().then(function(){t.refreshDelay===t.refreshInterval.ONETIME?t.collectState().then(function(){n.services.push(t),i.resolve(t)})["catch"](function(e){i.reject(e)}):(t.startService(),n.services.push(t),i.resolve(t))})["catch"](function(e){i.reject(e)}),i.promise):(i.reject((new o).addError("Invalid Context Plugin","Provided parameter was not a valid Flybits.context.ContextPlugin instance.",{code:o.type.NOTSUPPORTED,context:"contextPlugin"})),i.promise)},unregister:function(e){return e instanceof r.ContextPlugin&&(n.removeObject(this.services,e),e.stopService()),e},unregisterAll:function(){return this.stopAllServices(),this.services=[],this},stopAllServices:function(){for(var e=this.services,t=0;t<e.length;t++)e[t].stopService();return this},startAllServices:function(){for(var e=this.services,t=0;t<e.length;t++)e[t].startService();return this},startReporting:function(){var t=new e,r=this;return r.stopReporting(),s.resolveSession().then(function(e){var o;o=function(){r.report()["catch"](function(e){}).then(function(){r.isReporting&&(r._reportTimeout=setTimeout(function(){o()},r.reportDelay))}),r.isReporting=!0},o(),t.resolve()})["catch"](function(e){t.reject(e)}),t.promise},stopReporting:function(){return this.isReporting=!1,window.clearTimeout(this._reportTimeout),this},_gatherAllData:function(){for(var t=new e,r=this.services,o=[],n=[],i=[],s=0;s<r.length;s++)!function(e){var t=e._fetchCollected();i.push(t),t.then(function(t){Array.prototype.push.apply(o,t.data),n.push({serviceRef:e,keys:t.keys})})}(r[s]);return Promise.settle(i).then(function(){t.resolve({data:o,keys:n})}),t.promise},_sendReport:function(r,n){var s=new e,a=t.cfg.CTXHOST;return fetch(a,{method:"POST",credentials:"include",headers:{"X-Authorization":r},body:JSON.stringify(n)}).then(i.checkResult).then(i.getResultStr).then(function(e){s.resolve()})["catch"](function(e){i.getResultStr(e).then(function(t){var r=i.parseErrorMsg(t);s.reject((new o).addError("Context report failed.",r,{serverCode:e.status}))})}),s.promise},_cleanupServices:function(t){for(var r=new e,o=[],n=0;n<t.length;n++)!function(e){o.push(e.serviceRef._deleteCollected(e.keys))}(t[n]);return Promise.settle(o).then(function(){r.resolve()}),r.promise},report:function(){var t=this,r=new e,n=s.userToken,i=[];return n?(this._gatherAllData().then(function(e){return i=e.keys,t._sendReport(n,e.data)}).then(function(){return t._cleanupServices(i)}).then(function(){r.resolve()})["catch"](function(e){e instanceof o?r.reject(e):r.reject((new o).addError("Context report failed.",e,{code:o.UNEXPECTED}))}),r.promise):(r.reject(),r.promise)}};return a.reportDelay=t.cfg.CTXREPORTDELAY,a}(),r.ContextPlugin=function(){var e=t.Deferred,r=(t.Validation,function(e){if("Object"===this.constructor.name)throw new Error("Abstract classes cannot be instantiated");a.call(this),this._refreshTimeout=null,this.refreshDelay=e&&e.refreshDelay?e.refreshDelay:this.refreshInterval.ONEMINUTE,this.maxStoreSize=e&&e.maxStoreSize?e.maxStoreSize:80,this.maxStoreAge=e&&e.maxStoreAge?e.maxStoreAge:864e5,this.isServiceRunning=!1,this.lastCollected=-1,window.localforage?this._store=localforage.createInstance({name:this.TYPEID}):(console.error("> WARNING ("+this.TYPEID+"): `localforage` dependency not found. Reverting to temporary in memory storage."),this._store={contents:{},keys:function(){return Promise.resolve(Object.keys(this.contents))},removeItem:function(e){return delete this.contents[e],Promise.resolve()},setItem:function(e,t){return this.contents[e]=t,Promise.resolve(t)},getItem:function(e){var t=this.contents[e]?this.contents[e]:null;return Promise.resolve(t)},length:function(){return Promise.resolve(Object.keys(this.contents).length)}})});return r.prototype=Object.create(a.prototype),r.prototype.constructor=r,r.prototype["implements"]("ContextPlugin"),r.prototype.refreshInterval=r.refreshInterval={},r.prototype.refreshInterval.ONETIME=r.refreshInterval.ONETIME=-42,r.prototype.refreshInterval.THIRTYSECONDS=r.refreshInterval.THIRTYSECONDS=3e4,r.prototype.refreshInterval.ONEMINUTE=r.refreshInterval.ONEMINUTE=6e4,r.prototype.refreshInterval.ONEHOUR=r.refreshInterval.ONEHOUR=36e5,r.prototype.refreshInterval.ONEDAY=r.refreshInterval.ONEDAY=864e5,r.prototype.TYPEID=r.TYPEID="ctx.sdk.generic",r.prototype.startService=function(){this.stopService();var e;return e=function(t){t.collectState()["catch"](function(e){}).then(function(){t.isServiceRunning&&(t._refreshTimeout=setTimeout(function(){e(t)},t.refreshDelay))}),t.isServiceRunning=!0},e(this),this},r.prototype.stopService=function(){return this.isServiceRunning=!1,window.clearTimeout(this._refreshTimeout),this},r.prototype.collectState=function(){var t=new e,r=this,o=this._store,n=0;return o.length().then(function(e){return n=e,r.getState()}).then(function(e){return r._saveState(e)}).then(function(){r.lastCollected=(new Date).getTime(),n>=r.maxStoreSize&&r._validateStoreState(),t.resolve()})["catch"](function(e){console.error(">",r,e),t.reject()}),t.promise},r.prototype._validateStoreState=function(){var t=this,r=new e,o=[],n=this._store;return n.keys().then(function(e){var i=e,s=(new Date).getTime(),a=i.length-t.maxStoreSize;if(i.sort(function(e,t){return+e-+t}),a>0)for(var c=0;c<a;c++)o.push(n.removeItem(i.shift()));for(;i.length>0&&s-i[0]>=t.refreshInterval.ONEDAY;)o.push(n.removeItem(i.shift()));Promise.settle(o).then(function(){r.resolve()})})["catch"](function(){r.reject()}),r.promise},r.prototype._fetchCollected=function(){var t=this,r=new e,o=[],n=[],i=this._store;return i.keys().then(function(e){var s;(s=function(){if(e.length<=0)return void r.resolve({data:o,keys:n});var a=e.pop();n.push(a),i.getItem(a).then(function(e){o.push({timestamp:Math.round(+a/1e3),dataTypeID:t.TYPEID,value:t._toServerFormat(e)})})["catch"](function(){}).then(function(){s()})})()})["catch"](function(e){r.reject(e)}),r.promise},r.prototype._deleteCollected=function(t){var r,o=this._store,n=new e;return r=function(){if(t.length<=0)return void n.resolve();var e=t.pop();o.removeItem(e)["catch"](function(){}).then(function(){r()})},r(),n.promise},r.prototype._saveState=function(e){var t=(new Date).getTime();return this._store.setItem(t,e)},r}(),r.Connectivity=function(){var e=t.Deferred,o=t.util.Obj,n=function(e){r.ContextPlugin.call(this,e),e&&(this.opts=o.extend({},this.opts),o.extend(this.opts,e))};return n.prototype=Object.create(r.ContextPlugin.prototype),n.prototype.constructor=n,n.prototype.TYPEID=n.TYPEID="ctx.sdk.network",n.isSupported=n.prototype.isSupported=function(){
var t=new e;return t.resolve(),t.promise},n.getState=n.prototype.getState=function(){var r=new e,o=this;return"onLine"in navigator&&!this.opts.hardCheck?r.resolve({state:navigator.onLine?o.state.CONNECTED:o.state.DISCONNECTED}):fetch(t.cfg.HOST+"/ping").then(function(e){r.resolve({state:o.state.CONNECTED})})["catch"](function(e){r.resolve({state:o.state.DISCONNECTED})}),r.promise},n._toServerFormat=n.prototype._toServerFormat=function(e){return{connectionType:e.state}},n.state=n.prototype.state={},n.state.DISCONNECTED=n.prototype.state.DISCONNECTED=-1,n.state.CONNECTED=n.prototype.state.CONNECTED=-99,n.opts=n.prototype.opts={hardCheck:!1},n}(),r.Location=function(){var e=t.Deferred,o=t.util.Obj,n=function(e){r.ContextPlugin.call(this,e),e&&(this.opts=o.extend({},this.opts),o.extend(this.opts,e))};return n.prototype=Object.create(r.ContextPlugin.prototype),n.prototype.constructor=n,n.prototype.TYPEID=n.TYPEID="ctx.sdk.location",n.isSupported=n.prototype.isSupported=function(){var r=new e;return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){r.resolve()},function(e){console.error(">",e),r.reject((new t.Validation).addError("Location Sensing Not Supported",e.message?e.message:"User denied"))}):r.reject((new t.Validation).addError("Location Sensing Not Supported","Device GeoLocation API not found.")),r.promise},n.getState=n.prototype.getState=function(){var r=new e;return navigator.geolocation.getCurrentPosition(function(e){r.resolve({coords:{latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy},timestamp:e.timestamp})},function(e){console.error(">",e),r.reject((new t.Validation).addError("Location could not be resolved"))},this.opts),r.promise},n._toServerFormat=n.prototype._toServerFormat=function(e){return{lat:e.coords.latitude,lng:e.coords.longitude}},n.opts=n.prototype.opts={maximumAge:12e5},n}(),t.api.Tag=function(){var e=t.util.Api,r=t.Validation,o=t.Deferred,n=t.Tag,i=t.store.Session,s=null,a=function(e){var t={};if(!e)return t;if(e.id||e.ids){var o=e.ids?e.ids:[];e.id&&o.push(e.id),t.ids=o.join(";")}if(e.zid||e.zids){var i=e.zids?e.zids:[];e.zid&&i.push(e.zid),t.zoneids=i.join(";")}if(e.zmiID||e.zmiIDs){var s=e.zmiIDs?e.zmiIDs:[];e.zmiID&&s.push(e.zmiID),t.zonemomentinstanceids=s.join(";")}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new r).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:r.type.MISSINGARG});e.paging.limit&&(t.limit=e.paging.limit),e.paging.offset&&(t.offset=e.paging.offset)}if(e.orderBy){var a=e.orderBy.key;if(!a)throw(new r).addError("Missing Argument","orderBy requires a Tag model property key to order by.",{code:r.type.MISSINGARG,context:"orderBy.key"});if(!n.reqKeys[a])throw(new r).addError("Invalid Argument","Tag does not contain or cannot be ordered by this property:"+a,{code:r.type.INVALIDARG,context:"orderBy.key"});a=n.reqKeys[a];var c=e.orderBy.direction?e.orderBy.direction:"ascending";t.orderby=a+":"+c}if(e.search){for(var d=Object.keys(e.search),u=d.length,l={},p=[],f=new r;u--;){var h=d[u],g=e.search[h];n.reqKeys[h]||f.addError("Invalid Argument","Tag does not contain or cannot be searched by this property:"+h,{code:r.type.INVALIDARG,context:"search"}),h=n.reqKeys[h],l[g]?l[g]+=";"+h:l[g]=h}if(!f.state)throw f;for(var m=Object.keys(l),y=m.length;y--;){var v=m[y],I=l[v];p.push(v+":"+I)}t.search="search="+p.join("&search=")}return t},c={getPaging:function(){return s},findTags:function(e){return this.getTags({search:{label:e}})},getTag:function(e){var t=this,n=new o;if(!e||""===e)throw(new r).addError("Missing Argument","No Tag ID was provided.",{code:r.type.MISSINGARG,context:"id"});return this.getTags({id:e}).then(function(e){var o=e.result;o.length<=0&&0===t.getPaging().total?n.reject((new r).addError("Model Not Found","A Tag was not found with the supplied ID",{code:r.type.NOTFOUND,context:"id"})):o.length>0&&n.resolve(o[0])})["catch"](function(e){n.reject(e)}),n.promise},getTags:function(c){var d=new o,u=t.cfg.HOST+t.cfg.res.TAGS,l=a(c),p=i.deviceID;return l.search&&(u+="?"+l.search,delete l.search),l=e.toURLParams(l),""!==l&&(u+=u.indexOf("?")<0?"?":"&",u+=l.toString()),fetch(u,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(o){try{var i=e.parseResponse(o),a=e.parsePaging(i);s=a}catch(u){d.reject((new r).addError("Request Failed","Unexpected server response.",{code:r.type.MALFORMED}))}if(i&&i.data&&i.data.length>=0){var l=i.data.map(function(e){try{return new n(e)}catch(t){d.reject((new r).addError("Request Failed","Failed to parse server model.",{code:r.type.MALFORMED,context:i.data[0]}))}});d.resolve({result:l,nextPageFn:e.createNextPageCall(t.api.Tag.getTags,c,a)})}else d.reject((new r).addError("Tags retrieval failed","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);d.reject((new r).addError("Tags retrieval failed",n,{serverCode:t.status}))})}),d.promise}};return c}(),t.api.User=function(){var e=t.util.Api,r=t.util.Obj,o=t.Validation,n=t.Deferred,i=t.User,s=t.store.Session,a=null,c=function(e){var t={includeAllUsers:!0};if(!e)return t;if(e.id||e.ids){var r=e.ids?e.ids:[];e.id&&r.push(e.id),t.ids=r.join(";")}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new o).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:o.type.MISSINGARG});e.paging.limit&&(t.limit=e.paging.limit),e.paging.offset&&(t.offset=e.paging.offset)}if(e.orderBy){var n=e.orderBy.key;if(!n)throw(new o).addError("Missing Argument","orderBy requires a User model property key to order by.",{code:o.type.MISSINGARG,context:"orderBy.key"});if(!i.reqKeys[n])throw(new o).addError("Invalid Argument","User does not contain or cannot be ordered by this property:"+n,{code:o.type.INVALIDARG,context:"orderBy.key"});n=i.reqKeys[n];var s=e.orderBy.direction?e.orderBy.direction:"ascending";t.orderby=n+":"+s}if(e.search){for(var a=Object.keys(e.search),c=a.length,d={},u=[],l=new o;c--;){var p=a[c],f=e.search[p];i.reqKeys[p]||l.addError("Invalid Argument","User does not contain or cannot be searched by this property:"+p,{code:o.type.INVALIDARG,context:"search"}),p=i.reqKeys[p],d[f]?d[f]+=";"+p:d[f]=p}if(!l.state)throw l;for(var h=Object.keys(d),g=h.length;g--;){var m=h[g],y=d[m];u.push(m+":"+y)}t.search="search="+u.join("&search=")}return t},d=function(){var r=new n,o=t.cfg.HOST+t.cfg.res.SETREMEMBERME,i=s.deviceID;return fetch(o,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:i,"Content-Type":"application/json"}}).then(e.checkResult).then(e.getResultStr).then(function(e){r.resolve()})["catch"](function(e){r.reject()}),r.promise},u={register:function(r,a,c){var d=new n,u=t.cfg.HOST+t.cfg.res.REGISTER,l=s.deviceID,p={email:r,password:a,includeCredentialsJwt:!0};c&&(c.firstName&&(p.firstName=c.firstName),c.lastName&&(p.lastName=c.lastName),c.hasOwnProperty("includeAccessToken")&&(p.includeCredentialsJwt=c.includeAccessToken));var f=new o;if(r||f.addError("Missing Argument","Email is a required field for registration",{context:"email",code:o.type.MISSINGARG}),a||f.addError("Missing Argument","Password is a required field for registration",{context:"password",code:o.type.MISSINGARG}),!f.state)throw f;return fetch(u,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:l,"Content-Type":"application/json"},body:JSON.stringify(p)}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var r=e.parseResponse(t)}catch(n){d.reject((new o).addError("Registration Failed","Unexpected server response.",{code:o.type.MALFORMED}))}try{var a=new i(r);s.setSession(a),d.resolve(a)}catch(n){d.reject((new o).addError("User resolution failed.","Failed to parse server model.",{code:o.type.MALFORMED,context:r}))}})["catch"](function(t){e.getResultStr(t).then(function(r){var n=e.parseErrorMsg(r);d.reject((new o).addError("Registration Failed",n,{serverCode:t.status}))})}),d.promise},anonymousLogin:function(){var e=new n,o=r.guid()+"@flybits.eu",i=r.guid(2),a=null;return t.api.User.register(o,i,{firstName:"anonymous",lastName:r.guid(1)}).then(function(e){return a=e,d()}).then(function(){s.setSession(a),e.resolve(a)})["catch"](function(t){e.reject(t)}),e.promise},getPaging:function(){return a},login:function(r,a,c){var d=new n,u=t.cfg.HOST+t.cfg.res.LOGIN,l=s.deviceID,p={email:r,password:a,includeCredentialsJwt:!0};c&&(c.hasOwnProperty("rememberMe")&&(p.rememberMe=c.rememberMe),c.hasOwnProperty("includeAccessToken")&&(p.includeCredentialsJwt=c.includeAccessToken));var f=new o;if(r||f.addError("Missing Argument","Email is required to login",{context:"email",code:o.type.MISSINGARG}),a||f.addError("Missing Argument","Password is required to login",{context:"password",code:o.type.MISSINGARG}),l||f.addError("Missing Argument","A unique device ID is required to login",{context:"deviceID",code:o.type.MISSINGARG}),!f.state)throw f;return fetch(u,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:l,"Content-Type":"application/json","flybits-sdk-version":t.VERSION},body:JSON.stringify(p)}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var r=e.parseResponse(t)}catch(n){d.reject((new o).addError("Login Failed","Unexpected server response.",{code:o.type.MALFORMED}))}try{var a=new i(r);s.setSession(a),d.resolve(a)}catch(n){d.reject((new o).addError("User resolution failed.","Failed to parse server model.",{code:o.type.MALFORMED,context:r}))}})["catch"](function(t){e.getResultStr(t).then(function(r){var n=e.parseErrorMsg(r);d.reject((new o).addError("Login Failed",n,{serverCode:t.status}))})}),d.promise},logout:function(){var r=new n,i=t.cfg.HOST+t.cfg.res.LOGOUT,a=s.deviceID;return fetch(i,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:a,"flybits-sdk-version":t.VERSION}}).then(function(){r.resolve()})["catch"](function(t){e.getResultStr(t).then(function(n){var i=e.parseErrorMsg(n);r.reject((new o).addError("Logout Failed",i,{serverCode:t.status}))})}).then(function(){s.clearSession()}),r.promise},getAccessToken:function(){var r=new n,i=t.cfg.HOST+t.cfg.res.USERS+"/jwt",a=s.deviceID;return fetch(i,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:a,"Content-Type":"application/json","flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var n=e.parseResponse(t)}catch(i){r.reject((new o).addError("Request Failed","Unexpected server response.",{code:o.type.MALFORMED}))}n&&n.jwt?(s.setUserToken(n.jwt),r.resolve(n.jwt)):r.reject((new o).addError("User access token retrieval failed","Unexpected server response",{code:o.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(n){var i=e.parseErrorMsg(n);r.reject((new o).addError("User access token retrieval failed",i,{serverCode:t.status}))})}),r.promise},changePassword:function(r,i){var a=new n,c=t.cfg.HOST+t.cfg.res.CHANGEPASS,d=s.deviceID;return fetch(c,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:d,"Content-Type":"application/json","flybits-sdk-version":t.VERSION},body:JSON.stringify({currentPassword:r,newPassword:i})}).then(e.checkResult).then(e.getResultStr).then(function(e){a.resolve()})["catch"](function(t){e.getResultStr(t).then(function(r){var n=e.parseErrorMsg(r);a.reject((new o).addError("Password change failed",n,{serverCode:t.status}))})}),a.promise},getSignedInUser:function(){var r=new n,a=t.cfg.HOST+t.cfg.res.USERS,c=s.deviceID;return fetch(a,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"Content-Type":"application/json","flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var n=e.parseResponse(t)}catch(s){r.reject((new o).addError("Request Failed","Unexpected server response.",{code:o.type.MALFORMED}))}if(n&&n.data&&n.data.length>0)try{r.resolve(new i(n.data[0]))}catch(s){r.reject((new o).addError("Request Failed","Failed to parse server model.",{code:o.type.MALFORMED,context:n.data[0]}))}else r.reject((new o).addError("User retrieval failed","Unexpected server response",{code:o.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(n){var i=e.parseErrorMsg(n);r.reject((new o).addError("User retrieval failed",i,{serverCode:t.status}))})}),r.promise},getUser:function(e){var t=this,r=new n;if(!e||""===e)throw(new o).addError("Missing Argument","No User ID specified",{code:o.type.MISSINGARG,context:"id"});return this.getUsers({id:e}).then(function(e){var n=e.result;n.length<=0&&0===t.getPaging().total?r.reject((new o).addError("Model Not Found","A User was not found with the supplied ID",{code:o.type.NOTFOUND,context:"id"})):n.length>0&&r.resolve(n[0])})["catch"](function(e){r.reject(e)}),r.promise},getUsers:function(r){var d=new n,u=t.cfg.HOST+t.cfg.res.USERS,l=c(r),p=s.deviceID;return l.search&&(u+="?"+l.search,delete l.search),l=e.toURLParams(l),""!==l&&(u+=u.indexOf("?")<0?"?":"&",u+=l.toString()),fetch(u,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(n){try{var s=e.parseResponse(n),c=e.parsePaging(s);a=c}catch(u){d.reject((new o).addError("Request Failed","Unexpected server response.",{code:o.type.MALFORMED}))}if(s&&s.data&&s.data.length>=0){var l=s.data.map(function(e){try{return new i(e)}catch(t){d.reject((new o).addError("Request Failed","Failed to parse server model.",{code:o.type.MALFORMED,context:e}))}});d.resolve({result:l,nextPageFn:e.createNextPageCall(t.api.User.getUsers,r,c)})}else d.reject((new o).addError("Users retrieval failed","Unexpected server response",{code:o.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(r){var n=e.parseErrorMsg(r);d.reject((new o).addError("Users retrieval failed",n,{serverCode:t.status}))})}),d.promise}};return u}(),t.api.Zone=function(){var e=t.util.Api,r=t.Validation,o=t.Deferred,n=t.store.Session,i=t.Tag,s=t.Zone,a=null,c=function(e){var o={};if(!e)return o;if(e.id||e.ids){var n=e.ids?e.ids:[];e.id&&n.push(e.id),o.ids=n.join(";")}if(e.tag||e.tags){var s=e.tags?e.tags.map(function(e){if(e instanceof i)return e.id;throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tags"})}):[];if(e.tag){if(!(e.tag instanceof i))throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tag"});s.push(e.tag.id)}o.tagIds=s.join(";")}if(e.tagID||e.tagIDs){var s=e.tagIDs?e.tagIDs:[];e.tagID&&s.push(e.tagID),o.tagIds=o.tagIds?Array.prototype.push.apply(o.tagIds,s.join(";")):s.join(";")}if(e.location){if(!e.location.lat||!e.location.lng)throw(new r).addError("Missing Argument","location request parameter object must contain a lat and lng property.",{code:r.type.MISSINGARG,context:"location.lat,location.lng"});o.Location=e.location.lat+","+e.location.lng,e.location.range&&(o.Location+=","+e.location.range)}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new r).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:r.type.MISSINGARG,context:"paging.limit,paging.offset"});e.paging.limit&&(o.limit=e.paging.limit),e.paging.offset&&(o.offset=e.paging.offset)}if(e.orderBy){var a=e.orderBy.key;if(!a)throw(new r).addError("Missing Argument","orderBy requires a zone model property key to order by.",{code:r.type.MISSINGARG,context:"orderBy.key"});if(!t.Zone.reqKeys[a])throw(new r).addError("Invalid Argument","Zone does not contain or cannot be ordered by this property:"+a,{code:r.type.INVALIDARG,context:"orderBy.key"});a=t.Zone.reqKeys[a];var c=e.orderBy.direction?e.orderBy.direction:"ascending";o.orderby=a+":"+c}if(e.search){for(var d=Object.keys(e.search),u=d.length,l={},p=[],f=new r;u--;){var h=d[u],g=e.search[h];t.Zone.reqKeys[h]||f.addError("Invalid Argument","Zone does not contain or cannot be searched by this property:"+h,{code:r.type.INVALIDARG,context:"search"}),h=t.Zone.reqKeys[h],l[g]?l[g]+=";"+h:l[g]=h}if(!f.state)throw f;for(var m=Object.keys(l),y=m.length;y--;){var v=m[y],I=l[v];p.push(v+":"+I)}o.search="search="+p.join("&search=")}return o},d={getPaging:function(){return a},logConnect:function(i){var s=new o,a=t.cfg.HOST+t.cfg.res.ZONECONNECT.replace("{zid}",i),c=n.deviceID,d=new r;if(i||d.addError("Missing Argument","No Zone ID was provided.",{code:r.type.MISSINGARG,context:"zid"}),c||d.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!d.state)throw d;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);s.reject((new r).addError("Connection log failed.",n,{serverCode:t.status}))})}),s.promise},logDisconnect:function(i){var s=new o,a=t.cfg.HOST+t.cfg.res.ZONEDISCONNECT.replace("{zid}",i),c=n.deviceID,d=new r;if(i||d.addError("Missing Argument","No Zone ID was provided.",{code:r.type.MISSINGARG,context:"zid"}),c||d.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!d.state)throw d;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);s.reject((new r).addError("Disconnection log failed.",n,{serverCode:t.status}))})}),s.promise},getZone:function(e){var t=this,n=new o;if(!e||""===e)throw(new r).addError("Missing Argument","No Zone ID specified",{code:r.type.MISSINGARG,context:"id"});return this.getZones({id:e}).then(function(e){var o=e.result;o.length<=0&&0===t.getPaging().total?n.reject((new r).addError("Model Not Found","A Zone was not found with the supplied ID",{code:r.type.NOTFOUND,context:"id"})):o.length>0&&n.resolve(o[0])})["catch"](function(e){n.reject(e)}),n.promise},getZones:function(i){var d=new o,u=t.cfg.HOST+t.cfg.res.ZONES,l=c(i),p=n.deviceID;return l.search&&(u+="?"+l.search,delete l.search),l=e.toURLParams(l),""!==l&&(u+=u.indexOf("?")<0?"?":"&",u+=l.toString()),fetch(u,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(o){try{var n=e.parseResponse(o),c=e.parsePaging(n);a=c}catch(u){d.reject((new r).addError("Request Failed","Unexpected server response.",{code:r.type.MALFORMED}))}if(n&&n.data&&n.data.length>=0){var l=n.data.map(function(e){try{return new s(e)}catch(t){d.reject((new r).addError("Request Failed","Failed to parse server model.",{code:r.type.MALFORMED,context:e}))}});d.resolve({result:l,nextPageFn:e.createNextPageCall(t.api.Zone.getZones,i,c)})}else d.reject((new r).addError("Zones retrieval failed","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);d.reject((new r).addError("Zones retrieval failed",n,{serverCode:t.status}))})}),d.promise}};return d}(),t.api.ZoneMomentInstance=function(){var e=t.util.Api,r=t.Validation,o=t.Deferred,n=t.store.Session,i=t.Tag,s=t.ZoneMomentInstance,a=null,c=function(e){var t={};if(!e)return t;if(e.id||e.ids){var o=e.ids?e.ids:[];e.id&&o.push(e.id),t.ids=o.join(";")}if(e.zid||e.zids){var n=e.zids?e.zids:[];e.zid&&n.push(e.zid),t.zoneids=n.join(";")}if(e.tag||e.tags){var a=e.tags?e.tags.map(function(e){if(e instanceof i)return e.id;throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tags"})}):[];if(e.tag){if(!(e.tag instanceof i))throw(new r).addError("Invalid Argument","Not a valid Tag model instance.",{code:r.type.INVALIDARG,context:"tag"});a.push(e.tag.id)}t.tagIds=a.join(";")}if(e.tagID||e.tagIDs){var a=e.tagIDs?e.tagIDs:[];e.tagID&&a.push(e.tagID),t.tagIds=t.tagIds?Array.prototype.push.apply(t.tagIds,a.join(";")):a.join(";")}if(e.paging){if(!e.paging.limit&&!e.paging.offset)throw(new r).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:r.type.MISSINGARG});e.paging.limit&&(t.limit=e.paging.limit),e.paging.offset&&(t.offset=e.paging.offset)}if(e.orderBy){var c=e.orderBy.key;if(!c)throw(new r).addError("Missing Argument","orderBy requires a ZoneMomentInstance model property key to order by.",{code:r.type.MISSINGARG,context:"orderBy.key"});if(!s.reqKeys[c])throw(new r).addError("Invalid Argument","ZoneMomentInstance does not contain or cannot be ordered by this property:"+c,{code:r.type.INVALIDARG,context:"orderBy.key"});c=s.reqKeys[c];var d=e.orderBy.direction?e.orderBy.direction:"ascending";t.orderby=c+":"+d}if(e.search){for(var u=Object.keys(e.search),l=u.length,p={},f=[],h=new r;l--;){var g=u[l],m=e.search[g];s.reqKeys[g]||h.addError("Invalid Argument","ZoneMomentInstance does not contain or cannot be searched by this property:"+g,{code:r.type.INVALIDARG,context:"search"}),g=s.reqKeys[g],p[m]?p[m]+=";"+g:p[m]=g}if(!h.state)throw h;for(var y=Object.keys(p),v=y.length;v--;){var I=y[v],E=p[I];f.push(I+":"+E)}t.search="search="+f.join("&search=")}return t},d={getPaging:function(){return a},logConnect:function(i){var s=new o,a=t.cfg.HOST+t.cfg.res.ZMICONNECT.replace("{zmiID}",i),c=n.deviceID,d=new r;if(i||d.addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"zmiID"}),c||d.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!d.state)throw d;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);s.reject((new r).addError("Connection log failed.",n,{serverCode:t.status}))})}),s.promise},logDisconnect:function(i){var s=new o,a=t.cfg.HOST+t.cfg.res.ZMIDISCONNECT.replace("{zmiID}",i),c=n.deviceID,d=new r;if(i||d.addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"zmiID"}),c||d.addError("Missing Argument","No device ID was present in the current session. Be sure to initialize the SDK before using this function.",{code:r.type.MISSINGARG,context:"Flybits.store.Session.deviceID"}),!d.state)throw d;return fetch(a,{method:"POST",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION,"user-agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2793.0 Safari/537.36"}}).then(e.checkResult).then(function(){s.resolve()})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);s.reject((new r).addError("Disconnection log failed.",n,{serverCode:t.status}))})}),s.promise},getZMI:function(e){var t=this,n=new o;if(!e||""===e)throw(new r).addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"id"});return this.getZMIs({id:e}).then(function(e){var o=e.result;o.length<=0&&0===t.getPaging().total?n.reject((new r).addError("Model Not Found","A ZoneMomentInstance was not found with the supplied ID",{code:r.type.NOTFOUND,context:"id"})):o.length>0&&n.resolve(o[0])})["catch"](function(e){n.reject(e)}),n.promise},getZMIs:function(i){var d=new o,u=t.cfg.HOST+t.cfg.res.ZMIS,l=c(i),p=n.deviceID;return l.search&&(u+="?"+l.search,delete l.search),l=e.toURLParams(l),""!==l&&(u+=u.indexOf("?")<0?"?":"&",u+=l.toString()),fetch(u,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:p,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(o){try{var n=e.parseResponse(o),c=e.parsePaging(n);a=c}catch(u){d.reject((new r).addError("Request Failed","Unexpected server response.",{code:r.type.MALFORMED}))}if(n&&n.data&&n.data.length>=0){var l=n.data.map(function(e){try{return new s(e)}catch(t){d.reject((new r).addError("Request Failed","Failed to parse server model.",{code:r.type.MALFORMED,context:e}))}});d.resolve({result:l,nextPageFn:e.createNextPageCall(t.api.ZoneMomentInstance.getZMIs,i,c)})}else d.reject((new r).addError("ZoneMomentInstances retrieval failed","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);d.reject((new r).addError("ZoneMomentInstances retrieval failed",n,{serverCode:t.status}))})}),d.promise},getAccessToken:function(i){var s=new o,a=t.cfg.HOST+t.cfg.res.ZMIJWT.replace("{zmiID}",i),c=n.deviceID;if(!i)throw(new r).addError("Missing Argument","No ZoneMomentInstance ID was provided.",{code:r.type.MISSINGARG,context:"zmiID"});return fetch(a,{method:"GET",credentials:"include",headers:{ApiKey:t.cfg.APIKEY,physicalDeviceId:c,"flybits-sdk-version":t.VERSION}}).then(e.checkResult).then(e.getResultStr).then(function(t){try{var o=e.parseResponse(t)}catch(n){s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.","Unexpected server response.",{code:r.type.MALFORMED}))}o&&o.payload?s.resolve(o.payload):s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.","Unexpected server response",{code:r.type.MALFORMED}))})["catch"](function(t){e.getResultStr(t).then(function(o){var n=e.parseErrorMsg(o);return n&&"ZoneMomentInstanceNotFoundException"===n.exceptionType?void s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.","ZoneMomentInstance with provided ID was not found.",{code:r.type.NOTFOUND,context:"zmiID"})):void s.reject((new r).addError("Failed to retrieve ZoneMomentInstance access token.",n,{serverCode:t.status}))})}),s.promise}};return d}(),"object"==typeof window)window.Flybits=t,t.init=t.init.browser,t.store.Property=t.store.Property.browser,t.context=r;else if("object"==typeof exports&&"undefined"!=typeof module){var u=require("fs"),l=require("node-persist");t.init=t.init.server,t.store.Property=t.store.Property.server,module.exports=t}else"function"==typeof define&&define.amd?define(function(){return t.init=t.init.server,t.store.Property=t.store.Property.server,t}):(t.init=t.init.server,t.store.Property=t.store.Property.server,global.Flybits=t);"string"==typeof __dirname&&(t.cfg.store.RESOURCEPATH=__dirname+"/../res/"),t.store.Property.init();var p=new t.Deferred;t.ready=p.promise}();